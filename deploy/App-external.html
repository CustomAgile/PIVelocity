<!DOCTYPE html>
<html>
<head>
    <title>PI Throughput&#x2F;Velocity Chart</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Utils",{singleton:!0,getFieldForAggregationType:function(e){switch(e){case"acceptedleafcount":return"AcceptedLeafStoryCount";case"acceptedleafplanest":return"AcceptedLeafStoryPlanEstimateTotal";case"leafcount":return"LeafStoryCount";case"leafplanest":return"LeafStoryPlanEstimateTotal";case"prelimest":return"PreliminaryEstimateValue";case"refinedest":return"RefinedEstimate";default:return null}}});
                Ext.define("Calculator",{config:{bucketBy:"",aggregateBy:""},constructor:function(t){this.initConfig(t)},prepareChartData:function(t){var e=this._groupData(t.getRange()),r=_.keys(e);return"release"===this.bucketBy?this._generateStackedColumns(r,e):this._generateColumns(r,e)},_groupData:function(t){return _.groupBy(t,function(t){var e=t.get("ActualEndDate");return"month"===this.bucketBy?moment(e).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(e).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?t.get("Release")._refObjectName:"year"===this.bucketBy?moment(e).startOf("year").format("YYYY"):void 0},this)},_generateStackedColumns:function(t,e){var r=["Not Started","In Progress","Completed"],a={};return _.each(t,function(t){var n=e[t],u=_.groupBy(n,function(t){return t.get("ActualEndDate")?"Completed":t.get("ActualStartDate")?"In Progress":"Not Started"});_.each(r,function(t){a[t]=a[t]||[];var e=u[t];if("count"===this.aggregateBy)a[t].push(e&&e.length||0);else{var r=_.reduce(e,function(t,e){var r=Utils.getFieldForAggregationType(this.aggregateBy);return t+e.get(r)},0,this);a[t].push(r)}},this)},this),{categories:t,series:_.map(r,function(t){return{name:t,type:"column",data:a[t]}},this)}},_generateColumns:function(t,e){var r;return r="count"===this.aggregateBy?_.map(e,function(t,e){return[e,t.length]}):_.map(e,function(t,e){return[e,_.reduce(t,function(t,e){var r=Utils.getFieldForAggregationType(this.aggregateBy);return t+e.get(r)},0,this)]},this),{categories:t,series:[{name:this.aggregateBy.indexOf("count")>=0?"Throughput":"Velocity",type:"column",data:r}]}}});
                Ext.define("PIVelocityChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",autoScroll:!1,requires:["Calculator"],config:{defaultSettings:{bucketBy:"quarter",piType:"",aggregateBy:"count",query:""}},launch:function(){this.getSetting("piType")?this._loadPIModel(this.getSetting("piType")):Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}]}).load().then({success:function(e){this._loadPIModel(e[0].get("TypePath"))},scope:this})},_loadPIModel:function(e){Rally.data.wsapi.ModelFactory.getModel({type:e}).then({success:function(e){this.model=e,this._addChart()},failure:function(){Rally.ui.notify.Notifier.showError({message:'Unable to load model type "'+e+'". Please verify the settings are configured correctly.'})},scope:this})},getSettingsFields:function(){return[{name:"piType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,storeConfig:{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],autoLoad:!1,remoteFilter:!0,remoteSort:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(e){e.fireEvent("typeselected",e.getValue(),e.context)},ready:function(e){e.fireEvent("typeselected",e.getValue(),e.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(e){this.refreshWithNewContext(e)}}},{name:"aggregateBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,width:300,store:{fields:["name","value"],data:[{name:"Accepted Leaf Story Count",value:"acceptedleafcount"},{name:"Accepted Leaf Story Plan Estimate",value:"acceptedleafplanest"},{name:"Count",value:"count"},{name:"Leaf Story Count",value:"leafcount"},{name:"Leaf Story Plan Estimate",value:"leafplanest"},{name:"Preliminary Estimate",value:"prelimest"},{name:"Refined Estimate",value:"refinedest"}]},lastQuery:""},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:"",handlesEvents:{typeselected:function(e){Rally.data.ModelFactory.getModel({type:e,success:function(e){this.store.filterBy(function(t){return"release"!==t.get("value")||0===e.typeDefinition.Ordinal}),this.store.findRecord("value",this.getValue())||this.setValue("month")},scope:this})}}},{type:"query"}]},_addChart:function(){var e=this.getContext(),t=["Milestones","Tags"],a=[this.model.typePath],l={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:e.getScopedStateId("filters"),filterChildren:!1,modelNames:a,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:[],addQuickFilterConfig:{whiteListFields:t}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:t}}}}}}],context:e,modelNames:a,storeConfig:{filters:this._getFilters()}};this.add(l)},_getChartConfig:function(){return{xtype:"rallychart",chartColors:this._isByRelease()?["#CCCCCC","#00a9e0","#009933"]:["#009933"],storeType:"Rally.data.wsapi.Store",storeConfig:{context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:this.model},calculatorType:"Calculator",calculatorConfig:{bucketBy:this.getSetting("bucketBy"),aggregateBy:this.getSetting("aggregateBy")},chartConfig:{chart:{type:"column"},legend:{enabled:this._isByRelease()},title:{text:""},yAxis:{min:0,title:{text:this._getYAxisLabel()},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}},reversedStacks:!0},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!0,colorByPoint:!1}}}}},onTimeboxScopeChange:function(){this.callParent(arguments);var e=this.down("rallygridboard");e&&e.destroy(),this._addChart()},_getYAxisLabel:function(){var e=this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName;return this.getSetting("aggregateBy").indexOf("count")>=0?"Count":e},_getChartFetch:function(){return _.compact(["ActualStartDate","ActualEndDate","Release",Utils.getFieldForAggregationType(this.getSetting("aggregateBy"))])},_getChartSort:function(){return this._isByRelease()?[{property:"Release.ReleaseDate",direction:"ASC"}]:[{property:"ActualEndDate",direction:"ASC"}]},_getFilters:function(){var e=[];this._isByRelease()?e.push({property:"Release",operator:"!=",value:null}):e.push({property:"ActualEndDate",operator:"!=",value:null});var t=this.getContext().getTimeboxScope();return t&&t.isApplicable(this.model)&&!this._isByRelease()&&e.push(t.getQueryFilter()),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),e},_isByRelease:function(){return"release"===this.getSetting("bucketBy")}});

            Rally.launchApp('PIVelocityChartApp', {
                name:"PI Throughput&#x2F;Velocity Chart",
                parentRepos:"",
                version:"1.0.5"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
