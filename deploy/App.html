<!DOCTYPE html>
<html>
<head>
    <title>PI Throughput&#x2F;Velocity Chart</title>
    <!--  (c) 2020 Custom Agile.  All Rights Reserved. -->
    <!--  Build Date: Mon Oct 12 2020 10:16:19 GMT-0400 (Eastern Daylight Time) -->
    <!--  Version: "1.1.0"-->
    <!--  Repository: "https:/github.com/CustomAgile/utils-ancestor-pi-app-filter"-->
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.override(Rally.ui.inlinefilter.OperatorFieldComboBox,{_getAllowedQueryOperatorStore:function(){var e={fields:["name","displayName","OperatorName"],filters:[{property:"OperatorName",operator:"!=",value:"containsall"},{property:"OperatorName",operator:"!=",value:"containsany"},{property:"OperatorName",operator:"!=",value:"in"}],listeners:{load:function(e,t){_.each(t,function(t){var i=t.get("OperatorName");t.set("name",i),t.set("displayName",e.shouldReplaceOperatorName?i.replace("contains","="):i),t.commit(!1)},this),e.add(this.additionalOperators),e.commitChanges()},scope:this}};if(this.property){var t=this.model.getField(this.property),i=t.getAllowedQueryOperatorStore();i&&(e.autoLoad=!1,e.proxy=i.proxy.clone(),e.shouldReplaceOperatorName=t.isCollection())}return Ext.create("Ext.data.Store",e)}}),Ext.override(Rally.ui.inlinefilter.FilterFieldFactory,{_getBaseEditorConfig:function(e,t){if("CreatedBy"===e.name){return{xtype:"rallyusersearchcombobox",fieldLabel:e.displayName,allowNoEntry:!1,valueField:"_uuidRef",storeConfig:{models:[e.attributeDefinition.AllowedValueType._refObjectName],context:{workspace:t.getDataContext().workspace,project:null}}}}return this.callParent(arguments)}}),Ext.override(Rally.ui.inlinefilter.InlineFilterPanel,{_alignChevron:function(){this.chevron&&this.chevron.hide()},_createCloseButton:function(){}}),Ext.override(Ext.form.field.ComboBox,{select:function(e){e&&!e.get("ObjectID")&&"/allowedattributevalue/"===e.get("_uuidRef")||this.callParent(arguments)}}),Ext.override(Rally.ui.inlinefilter.QuickFilterPanel,{getFilters:function(){var e=[];return _.each(this.fields,function(t,i){if("ModelType"!==t.name&&!Ext.isEmpty(t.lastValue)&&!t.hasActiveError()){var s=t.lastValue,r=Rally.util.Ref.isRefUri(s),l=_.isNumber(Rally.util.Ref.getOidFromRef(s));if(r&&l&&"_ref"===t.valueField&&t.noEntryValue!==s){var o=t.getRecord();if(o){var n=o.get("_uuidRef");n&&(s=n)}}var a=_.isFunction(t.getFilter)?t.getFilter():Rally.data.wsapi.Filter.fromExtFilter({property:t.name,operator:t.operator,value:s});a&&"/allowedattributevalue/"!==a.value&&(t.allowNoEntry&&t.noEntryValue===s&&(a.value=null),Ext.apply(a,{name:t.name,rawValue:s,filterIndex:i+1}),e.push(a))}},this),e}}),Ext.override(Ext.form.field.Checkbox,{getState:function(){return{checked:this.getValue()}},applyState:function(e){"boolean"==typeof e.checked&&this.setValue(e.checked)}}),Ext.define("CustomAgile.multilevelfilter.ToggleButton",{extend:"Rally.ui.Button",alias:"widget.multifiltertogglebtn",stateful:!0,config:{iconCls:"icon-filter"},constructor:function(e){this.mergeConfig(e),this.callParent([this.config])},getState:function(){return{filtersHidden:this.filtersHidden}},setFiltersHidden:function(e){this.filtersHidden=e,this.saveState()}}),Ext.define("CustomAgile.ui.tutorial.MultiLevelFilterTutorial",{singleton:!0,welcomeHtml:"\n        <h3>This component enables filters to be applied to user stories and all levels within the portfolio item hierarchy, regardless of the artifact \n        type displayed in the app.</h3>\n\n        <h3><b>Note:</b> For grid apps that allow expanding individual rows to see child artifacts, these filters are only applied to the top-level artifact type. \n        Child artifacts will not be filtered.</h3>\n    ",defaultOffset:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],defaultChevronOffset:[{x:0,y:-14},{x:14,y:0},{x:0,y:14},{x:-8,y:0}],showWelcomeDialog:function(e){this.app=e,this.steps=this.getSteps(),this.app.showFiltersBtn&&this.app.showFiltersBtn.filtersHidden&&this.app._toggleFilters(this.app.showFiltersBtn);let t=Rally.getApp().getHeight()-25;this.welcomeDialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,layout:"fit",componentCls:"rly-popover dark-container",width:500,height:t<300?t:300,closable:!0,autoDestroy:!0,buttonAlign:"center",autoScroll:!0,title:"Using the Multi-Level Filter",items:{xtype:"component",html:this.welcomeHtml,padding:10,style:"font-size:12px;"},buttons:[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.welcomeDialog.close()},scope:this}},{xtype:"rallybutton",text:"Next",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(0),this.welcomeDialog.close()},scope:this}}]})},showNextStep:function(e){if(this.popover&&Ext.destroy(this.popover),e>=this.steps.length)return;if(-1===e)return void this.showWelcomeDialog(this.app);let t=this.steps[e];t.handler&&t.handler();let i=[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.popover.close()},scope:this}}];i.push({xtype:"rallybutton",text:"Previous",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(e-1)},scope:this}}),e<this.steps.length-1&&i.push({xtype:"rallybutton",text:"Next",cls:"primary rly-small",listeners:{click:function(){this.showNextStep(e+1)},scope:this}});let s=Rally.getApp().getHeight()-25;this.popover=Ext.create("Rally.ui.popover.Popover",{target:Rally.getApp().down(t.target).getEl(),placement:t.placement||["bottom","left","top","right"],chevronOffset:t.chevronOffset||this.defaultChevronOffset,offsetFromTarget:t.offset||this.defaultOffset,overflowY:"auto",maxWidth:550,maxHeight:s<700?s:700,toFront:Ext.emptyFn,buttonAlign:"center",title:t.title,listeners:{destroy:function(){this.popover=null},scope:this},html:`<div class="tutorial-popover-body">${t.html}</div>`,buttons:i})},getSteps:function(){let e=[];if(this.app.publisher&&e.push({target:"#pubSubIndicatorArea",placement:"right",title:"Broadcaster Indicator",offset:[{x:0,y:0},{x:0,y:0},{x:14,y:0},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:-40},{x:0,y:14},{x:-8,y:0}],html:'\n           <p><span class="icon-bullhorn icon-large"></span> This bullhorn icon indicates that the app is broadcasting the selected filters to any apps on the page\n         that are listening for filter changes.</p>\n            '}),this.app._showAncestorFilter()&&e.push({target:"#ancestorFilterArea",placement:"bottom",title:"Ancestor Filter",html:"\n         <p>The ancestor filter allows you to filter the data to show only artifacts that are descendants of the selected artifact. \n         Use the PI Type dropdown to choose which type of Portfolio Item you want the ancestor artifact to be.</p> \n            "}),this.app._showIgnoreProjectScopeControl()){let t;t=this.app.tabPanel?this.app.tabPanel.down("#ignoreScopeControl"):this.app.renderArea.down("#ignoreScopeControl"),this.app.tabPanel.setActiveTab(0);let i=t?0:-100;e.push({target:"#ignoreScopeControl",placement:"bottom",title:"Projects Tab (Scope Control)",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:15},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:i,y:14},{x:-8,y:0}],html:'\n           <p>This dropdown controls whether the filters and resulting data will be scoped to the current project (Obeying the user\'s \n        Project Scope Down and Project Scope Up settings), scoped across all projects within the workspace or scoped across specific projects selected by the user.</p>\n        <p>To select specific projects, select the "Specific Project(s)" value in the drop down and then select the projects in the Project Picker. \n        Also, you can check the "Show work from Child Projects" to include all the children of selected projects. At last click the Apply button to apply your selection(s).</p>\n        <p>Depending upon the app and the filters, scoping across all projects may result in performance issues or timeout errors from the server. To ensure \n        timely performance, use filters that will return a manageable number of results.</p>\n            '})}let t=this.app._showAncestorFilter()||this.app._showIgnoreProjectScopeControl()?0:-225;return e.push({target:"multifiltertogglebtn",placement:"bottom",title:"Hide/Clear/Apply Filter Buttons",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:14},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:t,y:14},{x:-8,y:0}],html:'\n           <ul class="filter-help-list">\n        <li><b>Show/Hide Filters: </b>Used to toggle the visibility of the filter controls. Use this to hide the filters if they\'re \n        not needed or more space is needed within the app</li>\n        \n        <li><b>Clear Filters: </b>Once at least 1 filter is applied, this button will appear. This button will clear all of the quick filters and advanced filters across all artifact types. \n        Upon clearing the filters, the app will refresh its data.</li>\n        \n        <li><b>Apply Filters: </b>If present, this button becomes active after a single change is made to one of the filters. This button \n        allows the user to make multiple changes without the app refreshing after each change. Once the user has modified all of \n        the necessary filters, clicking this button will apply it to the app and refresh the data. If this button is not present, \n        the app will refresh after each change made to the filters.</li>\n        </ul>\n            '},{target:"#multiLevelFilterTabPanel tabbar",placement:"bottom",title:"Artifact Type Tabs",offset:[{x:0,y:0},{x:0,y:0},{x:0,y:14},{x:0,y:0}],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:-25,y:14},{x:-8,y:0}],html:"\n           <p>Each tab contains a unique filter that will apply filters at the level of the specified artifact type. \n        If the tab title ends with a number in parenthesis, this indicates the current number of filters applied at that level.</p>\n            "},{target:"#"+this.app.btnRenderAreaId,placement:"bottom",title:"Errors",chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:0,y:28},{x:-8,y:0}],html:"\n            <h4><i>One of the filters is trying to return too many records and would result in timeouts...</i></h4>\n        <ul>\n        <li>Often times, when using filters on artifact types above or below the artifact type displayed within the app, it's necessary \n        to first fetch those artifacts at that level in order to properly apply the filters. If the number of artifacts fitting those \n        filters is too large, it's too slow or impossible to retrieve all of them in order to then use them as filters afterwards.\n        <br><br>\n        <b>Example: </b>\n        Using a grid to display Features across all projects. We only want to see Features that have User Stories that are blocked. \n        Since there's no way to directly search for Features containing blocked stories, we must first find all blocked stories so we can \n        build a list of Features that are tied to those stories. And since we're scoping across all projects, we must query for all blocked \n        stories across the workspace. The results would be over ten thousand records, which would take very long to load, or would fail \n        to load due to timeout errors. This is an example of when we would see this error. Using more specific filters, or scoping to a specific \n        project hierarchy would solve this issue.\n        </li>\n        </ul>\n            "}),e}}),Ext.define("Utils.AncestorPiAppFilter",{alias:"plugin.UtilsAncestorPiAppFilter",version:"1.4.0",mixins:["Ext.AbstractPlugin","Rally.Messageable"],extend:"Ext.Component",statics:{RENDER_AREA_ID:"utils-ancestor-pi-app-filter",PANEL_RENDER_AREA_ID:"multi-level-pi-app-filter-panel"},config:{renderAreaId:"utils-ancestor-pi-app-filter",btnRenderAreaId:"utils-ancestor-pi-app-filter",panelRenderAreaId:"multi-level-pi-app-filter-panel",displayMultiLevelFilter:!1,projectScope:"user",publisher:!1,allowNoEntry:!0,settingsConfig:{},defaultFetch:!0,whiteListFields:["Tags","Milestones","c_EAEpic","c_EnterpriseApprovalEA","DisplayColor"],overrideGlobalWhitelist:!1,blackListFields:[],filterChildren:!1,ancestorLabel:"With ancestor",ancestorLabelWidth:110,ownerLabel:"and owned by",ownerOnlyLabel:"Owned by",ownerLabelWidth:110,labelStyle:"font-size: medium",singleRowMinWidth:840,defaultFilterFields:[],filtersHidden:!1,advancedFilterCollapsed:!1,visibleTab:void 0,disableGlobalScope:!1},filterControls:[],portfolioItemTypes:[],readyDeferred:null,piTypesDeferred:null,isSubscriber:!1,changeSubscribers:[],publishedValue:{},defaultTab:0,constructor:function(){this.callParent(arguments),this._setupPubSub(),Ext.tip.QuickTipManager.init()},initComponent:function(){this.callParent(arguments),this.addEvents("ready","select","change")},init:function(e){this.cmp=e,this.cmp.on("resize",this._onCmpResize,this),this.renderArea=this.cmp.down("#"+this.renderAreaId),this.btnRenderArea=this.cmp.down("#"+this.btnRenderAreaId),this.panelRenderArea=this.cmp.down("#"+this.panelRenderAreaId),this.projectScope=this.projectScope&&this.projectScope.toLowerCase()||"",(!this.projectScope||"user"!==this.projectScope&&"current"!==this.projectScope&&"workspace"!==this.projectScope)&&(this.projectScope="user");var t=this.cmp.getSettingsFields;this.cmp.getSettingsFields=function(){return this._getSettingsFields(t.apply(e,arguments))}.bind(this);var i=this.cmp.defaultSettings;i["Utils.AncestorPiAppFilter.enableAncestorPiFilter2"]=!1,i["Utils.AncestorPiAppFilter.projectScope"]=this.projectScope,i["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]=this.displayMultiLevelFilter,i["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"]="true",i["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"]="true",i["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"]="true",this.cmp.setDefaultSettings(i),this.projectsChanged=!0,this._getGlobalWhitelist().then({scope:this,success:function(e){this.whiteListFields=e,this._getTypeDefinitions().then({scope:this,success:function(){Promise.all([this._addAncestorControls(),this._addFilters()]).then(function(){setTimeout(function(){this._setReady()}.bind(this),500)}.bind(this),function(e){this._showError(e,"Failed while adding ancestor and multilevel filters"),this._setReady()}.bind(this))},failure:function(){this._showError("Failed to fetch portfolio item types for multi-level filter")}})}})},_getGlobalWhitelist:function(){let e=Ext.create("Deft.Deferred"),t="multi-level-filter-whitelist-fields-preference-"+this.cmp.getContext().getWorkspaceRef();return this.overrideGlobalWhitelist?(e.resolve(this.whiteListFields),e.promise):(Rally.data.PreferenceManager.load({filterByName:t,scope:this,success:function(i){if(i&&i.hasOwnProperty(t))try{let s=i[t].split(",");s&&s.length?e.resolve(s):e.resolve(this.whiteListFields)}catch(t){e.resolve(this.whiteListFields)}else e.resolve(this.whiteListFields)}}),e.promise)},_getTypeDefinitions:function(){let e=Ext.create("Deft.Deferred");return Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes().then({scope:this,success:function(t){this.portfolioItemTypes=t,Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("TypeDefinition"),fetch:["Name","Ordinal","TypePath"],requester:this,filters:[{property:"Name",value:"Hierarchical Requirement"}]}).load({scope:this,callback:function(t,i,s){s&&t&&t.length?(this.storyType=t[0],this.allTypes=[this.storyType].concat(this.portfolioItemTypes),Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("TypeDefinition"),fetch:["Name","Ordinal","TypePath"],requester:this,filters:[{property:"Name",value:"Defect"}]}).load({scope:this,callback:function(t,i,s){s&&t&&t.length?(this.defectType=t[0],this.allTypes=[this.defectType].concat(this.allTypes),e.resolve()):e.reject()}})):e.reject()}})},failure:function(){e.reject()}}),e.promise},notifySubscribers:async function(e){var t=this._getValue();t.changeType=e,this.projectsChanged&&(Rally.getApp().setLoading("Loading Projects...."),await this.loadProjects(),Rally.getApp().setLoading(!1)),t.projects=this.projects,_.each(this.changeSubscribers,function(e){this.publish(e,t)},this)},getAncestorFilterForType:function(e){var t,i=e.toLowerCase(),s=this._getValue();if(s.piTypePath){var r=s.piTypePath,l=s.isPiSelected,o=s.pi,n=this._getAncestorTypeArray(i,r);if(l&&null!==o&&null!==n){var a=this._getPropertyPrefix(i,n);a&&(t=new Rally.data.wsapi.Filter({property:a,value:o}))}else null!==o&&(t=new Rally.data.wsapi.Filter({property:"ObjectID",value:0}))}return t},getAllFiltersForType:async function(e,t){let i=this.getAncestorFilterForType(e),s=i?[i]:[],r=await this.getMultiLevelFiltersForType(e,t);return s=s.concat(r),this.useSpecificProjects()&&(await this.getProjects(),s.push(new Rally.data.wsapi.Filter({property:"Project",operator:"in",value:_.map(this.projects,function(e){return e.get("_ref")})}))),s},getMultiLevelFiltersForType:async function(e,t){let i=[],s=e.toLowerCase(),r=this.getMultiLevelFilters();if(!r||!Object.keys(r).length)return i;let l=this._getAllTypePaths();for(let e=_.findIndex(l,function(e){return e.toLowerCase()===s});e<l.length;e++){let t=l[e],o=r[t];if(o&&o.length)if(s===t.toLowerCase())i=i.concat(this._getWsapiFilter(s));else{let e=await this._getParentFilters(s,t,o);i=i.concat(e)}}if(t&&(Ext.String.startsWith(e.toLowerCase(),"portfolioitem")||Ext.String.startsWith(e.toLowerCase(),"hierarchicalrequirement"))){let t=this._getChildFiltersForType(e);t&&(i=i.concat(t))}return i},getFiltersOfSingleType:async function(e){return this._getWsapiFilter(e)},getMultiLevelFilters:function(){if(this._isSubscriber())return this.publishedValue.filters||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getFilters()}),e},getMultiLevelWsapiFilters:function(){if(this._isSubscriber())return this.publishedValue.wsapiFilters||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getWsapiFilter()}),e},_getChildFiltersForType:function(e){let t=this._getAllTypePaths(),i="",s=[];for(let r=_.findIndex(t,function(t){return t.toLowerCase()===e.toLowerCase()})-1;r>=0;r--){let e=t[r];i=i+(i.length?".":"")+("hierarchicalrequirement"===e.toLowerCase()?"UserStories":"defect"===e.toLowerCase()?"Defects":"Children"),s=s.concat(this._getWsapiFilter(e,i))}return s},_getParentFilters:async function(e,t,i){let s=this._getAncestorTypeArray(e,t);if(null!==s){let r=this._getPropertyPrefix(e,s);if(r){let e=this._hasCustomFilters(i),s=[new Rally.data.wsapi.Filter({property:r+".ObjectID",operator:"=",value:0})];if(!e||!this.getIgnoreProjectScope())return this._getWsapiFilter(t,r);{let e=[];try{let i=this._getWsapiFilter(t);return(e=await new Promise(function(e,s){this._getFilteredRecords(i,t,e,s)}.bind(this)).catch(e=>(this._showError(e,"Failed while loading filters for parent artifacts"),[])))&&e.length?[new Rally.data.wsapi.Filter({property:r+".ObjectID",operator:"in",value:_.map(e,function(e){return e.get("ObjectID")})})]:s}catch(e){return this._showError(e,"Failed while loading filters for parent artifacts"),s}}}}return[]},_getWsapiFilter:function(e,t){let i;if(this._isSubscriber()){if(this.publishedValue.wsapiFilters)for(let t in this.publishedValue.wsapiFilters)if(t.toLowerCase()===e.toLowerCase()){(i=this.publishedValue.wsapiFilters[t])&&(i=i.clone());break}}else this.filterControls&&_.each(this.filterControls,function(t){(t.inlineFilterButton.modelNames||"unknown").toLowerCase()===e.toLowerCase()&&(i=t.inlineFilterButton.getWsapiFilter())&&(i=i.clone())});return i&&(this._updateColorAndCustomFilters(i),t&&this._updateWsapiFilterWithPrefix(i,t)),i?[i]:[]},_updateColorAndCustomFilters:function(e){e&&(e.property&&"object"==typeof e.property&&this._updateColorAndCustomFilters(e.property),"object"==typeof e.value?this._updateColorAndCustomFilters(e.value):("string"==typeof e.value&&/^#[0-9a-f]{3,6}$/i.test(e.value)&&(e.value=e.value.toLowerCase()),"HasDefects"!==e.property&&"HasStories"!==e.property||(e.property="HasDefects"===e.property?"Defects.ObjectID":"UserStories.ObjectID",e.operator=("="===e.operator||"in"===e.operator)&&e.value||"!="===e.operator&&!e.value?"!=":"=",e.value=null)))},_updateWsapiFilterWithPrefix:function(e,t){e&&(e.property&&("string"==typeof e.property?(e.config&&e.property===e.config.property&&(e.config.property=`${t}.${e.property}`),e.initialConfig&&e.property===e.initialConfig.property&&(e.initialConfig.property=`${t}.${e.property}`),e.property=`${t}.${e.property}`):this._updateWsapiFilterWithPrefix(e.property,t)),"object"==typeof e.value&&this._updateWsapiFilterWithPrefix(e.value,t))},_hasCustomFilters:function(e){for(let t of e)if(-1!==t.property.indexOf("c_")&&"string"==typeof t.value)return!0;return!1},_convertReleaseFilters:async function(e){if(this.getIgnoreProjectScope())for(let t=0;t<e.length;t++)if("Release"===e[t].property){let i=await this._getRelease(e[t].value);i&&(e[t]=new Rally.data.wsapi.Filter({property:"Release.Name",value:i.Name}))}},_getRelease:async function(e){let t=Ext.create("Deft.Deferred");return Ext.Ajax.request({url:Ext.String.format("/slm/webservice/v2.0{0}?fetch=Name",e),success(e){if(e&&e.responseText){let i=Ext.JSON.decode(e.responseText);i&&i.Release?t.resolve(i.Release):t.resolve(null)}else t.resolve(null)}}),t.promise},getSelectedPiRecord:function(){return this._isSubscriber()?this.publishedValue.piRecord:this.piSelector&&this.piSelector.getRecord()},getIgnoreProjectScope:function(){return this._ignoreProjectScope()},getCurrentView:function(){let e=this._getValue(),t={...this.cmp.defaultSettings,...this.cmp.getSettings()},i={};for(let e of Object.keys(t))(e.indexOf("AncestorPiAppFilter")>-1||e.indexOf("MultiLevelPiAppFilter")>-1)&&(i[e]=t[e]);return e.settings=i,"user"===i["Utils.AncestorPiAppFilter.projectScope"]&&"specific"===e.scope?(e.projects=this.projectPicker.getProjectRefs(),e.searchChildProjects=this.projectPicker.includeChildProjects()):e.projects=[],delete e.piRecord,delete e.wsapiFilters,e},setCurrentView:async function(e){e.settings&&(this._checkViewSettings(e),this.cmp.updateSettingsValues(e.settings)),this.ready=!1,this.projectsChanged=!0,this.projects=[],await this.setMultiLevelFilterStates(e.filterStates),this.projectPicker&&(e.projects&&e.projects.length?await this.projectPicker.setValueFromPrjRef(e.projects,e.searchChildProjects||!1):this.projectPicker.reset()),e.piTypePath&&this._setPiSelector(e.piTypePath,e.pi);let t=this.cmp.down("#ignoreScopeControl");t&&(e.scope?(t.setValue(e.scope),"specific"===e.scope?this.hideShowProjectPicker("show"):this.hideShowProjectPicker("hide")):(t.setValue(e.ignoreProjectScope),this.hideShowProjectPicker("hide")),this.projectPicker&&this.projectPicker.down("#applyProjectsBtn").hide())},_setScopeControlToSpecific:function(){let e=this.cmp.down("#ignoreScopeControl");e&&(e.setValue("specific"),this.hideShowProjectPicker("show")),this.projectPicker&&this.projectPicker.down("#applyProjectsBtn").hide()},_checkViewSettings:function(e){let t=e.settings["Utils.AncestorPiAppFilter.projectScope"],i=e.settings["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"];i="boolean"==typeof i?i:"true"===i;let s={...this.cmp.defaultSettings,...this.cmp.getSettings()},r=s["Utils.AncestorPiAppFilter.projectScope"],l=s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"];if(l="boolean"==typeof l?l:"true"===l,t!==r&&i&&l){let e=`<p> Unable to set saved view project scoping. App is currently set to scope to "\n                        ${"current"===r?"Users current project(s)":"workspace"===r?"All projects in workspace":"User selectable via projects tab"}" where as it should be set to "${"current"===t?"Users current project(s)":"workspace"===t?"All projects in workspace":"User selectable via projects tab"}" </p>`;this.Dialog=Ext.create("Rally.ui.dialog.Dialog",{autoShow:!0,layout:"fit",componentCls:"rly-popover dark-container",width:400,height:200,closable:!0,autoDestroy:!0,buttonAlign:"center",autoScroll:!0,title:"Warning",items:{xtype:"component",html:e,padding:10,style:"font-size:12px;"},buttons:[{xtype:"rallybutton",text:"Close",cls:"secondary rly-small",listeners:{click:()=>{this.Dialog.close()},scope:this}}]})}},getMultiLevelFilterStates:function(){if(this._isSubscriber())return this.publishedValue.filterStates||{};var e={};return this.filterControls&&_.each(this.filterControls,function(t){let i=t.inlineFilterButton.modelNames||"unknown";e[i]=t.inlineFilterButton.getState()}),e},getModels:function(){return this.models},getPortfolioItemTypes:function(){return this.portfolioItemTypes},getLowestPortfolioItemType:function(){return this.portfolioItemTypes[0]},setMultiLevelFilterStates:async function(e){if(this._isSubscriber())this.ready=!0;else if(e){this.suspendEvents(!1),this._clearAllFilters(!0),this.tabPanel&&this.tabPanel.removeAll();try{for(let t=0;t<this.filterControls.length;t++){let i=this.filterControls[t].inlineFilterButton,s=i.modelNames||"unknown";i.applyState(e[s]||{})}}catch(e){this._showError(e)}await this.addProjectPicker(),setTimeout(function(){this.ready=!0,this.resumeEvents(),this.tabPanel&&this.tabPanel.setActiveTab(this.defaultTab),this._onChange()}.bind(this),1500)}else this.ready=!0,this._clearAllFilters(!1)},mergeLegacyFilter:function(e,t,i,s){if(!this._isSubscriber()&&e&&t&&i){for(let s in e)if(e.hasOwnProperty(s)&&s===i)try{let i=e[s];if(t.matchType&&(i.matchType=t.matchType),"string"==typeof t.condition&&(i.condition=t.condition),t.quickFilters){if(t.quickFilterFields&&!t.quickFilterFields.length)for(let e of t.quickFilters)t.quickFilterFields.push(e.name);i.quickFilters=_.merge(i.quickFilters,t.quickFilters)}t.advancedFilters&&(i.advancedFilters=_.merge(i.advancedFilters,t.advancedFilters)),t.quickFilterFields&&(i.quickFilterFields=_.merge(i.quickFilterFields,t.quickFilterFields))}catch(e){console.error("Failed to merge legacy filter into multi-level filter")}s&&this.setMultiLevelFilterStates(e)}},_getFilteredRecords:async function(e,t,i,s){let r=Rally.getApp().getContext().getDataContext();this.getIgnoreProjectScope()&&(r.project=null);let l=this.getAncestorFilterForType(t);l&&l.value&&e.push(l);let o=["ObjectID"];"HierarchicalRequirement"===t?o.push("Feature"):o.push("Parent");let n=await this._getTotalResultCount(r,e,t);if(-1===n)s("Multi-level filter failed while filtering out items above or below selected portfolio item type.");else if(0===n)i([]);else if(n>6e3)s("One of the filters is trying to return too many records and would result in long load times or timeouts, try using more specific filters to reduce the total result-set.");else{Ext.create("Rally.data.wsapi.Store",{autoLoad:!1,context:r,filters:e,model:t,fetch:o,limit:1/0,enablePostGet:!0}).load().then({scope:this,success:function(e){i(e)},failure:function(){s("Multi-level filter failed while filtering out items above or below selected portfolio item type. Result set was probably too large.")}})}},_getTotalResultCount:function(e,t,i){let s=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.wsapi.Store",{autoLoad:!1,context:e,filters:t,model:i,fetch:["_ref"],limit:1,enablePostGet:!0});return r.load().then({scope:this,success:function(){s.resolve(r.totalCount)},failure:function(){s.resolve(-1)}}),s.promise},_setupPubSub:function(){this.publisher?(this.subscribe(this,"registerChangeSubscriber",async function(e){_.contains(this.changeSubscribers,e)||this.changeSubscribers.push(e);let t={};this.ready&&(t=this._getValue(),this.projectsChanged&&await this.loadProjects(),t.projects=this.projects),this.publish(e,t)},this),this.publish("reRegisterChangeSubscriber")):(this.subscriberEventName=Rally.getApp().getAppId()+this.$className,this.subscribe(this,this.subscriberEventName,function(e){this.isSubscriber||(this.isSubscriber=!0,this._hideControlCmp()),e.ready&&(this.intervalTimer&&(clearInterval(this.intervalTimer),delete this.intervalTimer),this.publishedValue=e,"ancestor"!==e.changeType&&e.changeType?"cancelFilters"===e.changeType?this._onCancel():this._onChange():this._onSelect())},this),this.publish("registerChangeSubscriber",this.subscriberEventName),this.registerAttempts=0,this.intervalTimer=setInterval(()=>{this.registerAttempts++,this.registerAttempts>=15?(clearInterval(this.intervalTimer),delete this.intervalTimer,delete this.registerAttempts):this.publish("registerChangeSubscriber",this.subscriberEventName)},800),this.subscribe(this,"reRegisterChangeSubscriber",function(){this.publish("registerChangeSubscriber",this.subscriberEventName)},this))},_getValue:function(){var e={};if(this._isSubscriber())e=this.publishedValue||{};else if(this.cmp&&this.ready){if(this.piTypeSelector){var t=this.piTypeSelector.getRecord();if(t&&this.piSelector){var i=t.get("TypePath"),s=this.piSelector.getRecord(),r=this.piSelector.getValue();_.merge(e,{piTypePath:i,isPiSelected:!!r,pi:r,piRecord:s})}}e.ignoreProjectScope=this._ignoreProjectScope(),e.filters=this.getMultiLevelFilters(),e.filterStates=this.getMultiLevelFilterStates(),e.wsapiFilters=this.getMultiLevelWsapiFilters(),e.scope=this.getProjectScope(),e.ready=this.ready}return e},_setReady:function(){if(this.cmp.on("beforehide",()=>{this.filterHelpBtn&&this.filterHelpBtn.hide()}),this.cmp.on("beforeshow",()=>{this.filterHelpBtn&&this.filterHelpBtn.show()}),!this._showMultiLevelFilter()&&this.filterHelpBtn&&this.filterHelpBtn.hide(),this._isSubscriber()){if(this.tabPanel&&this.tabPanel.hide(),this.showFiltersBtn&&this.showFiltersBtn.hide(),this.filterHelpBtn&&this.filterHelpBtn.hide(),!this.publishedValue.filters)return void setTimeout(function(){this.ready=!0,this.fireEvent("ready",this)}.bind(this),3e3)}else this._updateReleaseValues();this.ready=!0,this.fireEvent("ready",this)},_onSelect:function(){this.ready&&this.fireEvent("select",this)},_onCancel:function(){this.ready&&this.fireEvent("cancel",this.getMultiLevelFilters())},_onChange:function(){this.ready&&this.fireEvent("change",this.getMultiLevelFilters())},hideHelpButton:function(){this.filterHelpBtn&&this.filterHelpBtn.hide()},showHelpButton:function(){this.filterHelpBtn&&this.filterHelpBtn.show()},_getSettingsFields:function(e){var t=Rally.getApp().getSettings();t.hasOwnProperty("Utils.AncestorPiAppFilter.projectScope")||(t["Utils.AncestorPiAppFilter.projectScope"]=this.projectScope),t.hasOwnProperty("Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter")||(t["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]=this.displayMultiLevelFilter);let i=t["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"],s=t["Utils.AncestorPiAppFilter.projectScope"];var r=[{xtype:"rallycheckboxfield",id:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",name:"Utils.AncestorPiAppFilter.enableAncestorPiFilter2",fieldLabel:"Filter artifacts by ancestor portfolio item"},{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.defaultPiType",name:"Utils.AncestorPiAppFilter.defaultPiType",fieldLabel:"Default Portfolio Item type",valueField:"TypePath",allowNoEntry:!1,defaultSelectionPosition:"last",plugins:[]},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter",name:"Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter",fieldLabel:"Enable multi-level portfolio item filter",value:i,listeners:{scope:this,change:function(e,t){i=!!t,e.fireEvent("updateRadio",t,this.disableGlobalScope)}},bubbleEvents:["updateRadio"]},{xtype:"radiogroup",itemId:"radioButtons",fieldLabel:"Show artifacts from",columns:1,vertical:!0,allowBlank:!1,name:"Utils.AncestorPiAppFilter.projectScope",items:[{boxLabel:"User's current project(s).",name:"Utils.AncestorPiAppFilter.projectScope",itemId:"currentRadio",inputValue:"current",checked:"current"===s,disabled:this.disableGlobalScope&&(!0===i||"true"===i)},{boxLabel:"All projects in workspace.",name:"Utils.AncestorPiAppFilter.projectScope",inputValue:"workspace",checked:"workspace"===s&&!this.disableGlobalScope,disabled:this.disableGlobalScope},{boxLabel:!0===i||"true"===i?"User selectable via projects tab.":"User selectable (either current project(s) or all projects in workspace).",name:"Utils.AncestorPiAppFilter.projectScope",itemId:"userRadio",inputValue:"user",checked:"user"===s||this.disableGlobalScope&&(!0===i||"true"===i),disabled:this.disableGlobalScope&&!(!0===i||"true"===i)}],listeners:{scope:this,change:function(e,t){e.fireEvent("checkBoxDisplay",t,this.disableGlobalScope)}},handlesEvents:{updateRadio:function(e,t){this.down("#userRadio").setBoxLabel(!0===i||"true"===i?"User selectable via projects tab.":"User selectable (either current project(s) or all projects in workspace)."),t&&!0!==i&&"true"!==i?(this.down("#userRadio").setValue(!1),this.down("#userRadio").disable(),this.down("#currentRadio").setValue(!0),this.down("#currentRadio").enable()):!t||!0!==i&&"true"!==i||(this.down("#userRadio").setValue(!0),this.down("#userRadio").enable(),this.down("#currentRadio").setValue(!1),this.down("#currentRadio").disable()),this.fireEvent("checkBoxDisplay1",!!this.down("#userRadio").value&&this.down("#userRadio").inputValue,e,t)}},bubbleEvents:["checkBoxDisplay","checkBoxDisplay1"]},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent",fieldLabel:"Current Project",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"],hidden:!("user"===s&&(!0===i||"true"===i)),checked:this.disableGlobalScope,style:{marginLeft:"5%"},handlesEvents:{checkBoxDisplay:function(e,t){"user"===e["Utils.AncestorPiAppFilter.projectScope"]&&!0==(!0===i||"true"===i)?this.show():this.hide()},checkBoxDisplay1:function(e,t,i){!0===t&&"user"===e?this.show():this.hide()}}},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownAny",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownAny",fieldLabel:"Any Project",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"],hidden:!("user"===s&&(!0===i||"true"===i)&&!this.disableGlobalScope),style:{marginLeft:"5%"},handlesEvents:{checkBoxDisplay:function(e,t){"user"!==e["Utils.AncestorPiAppFilter.projectScope"]||!0!==i&&"true"!==i||t?(this.hide(),this.setValue(!1)):this.show()},checkBoxDisplay1:function(e,t,i){!0!==t||"user"!==e||i?(this.hide(),this.setValue(!1)):this.show()}}},{xtype:"rallycheckboxfield",id:"Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific",name:"Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific",fieldLabel:"User Specific",value:t["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"],hidden:!("user"===s&&(!0===i||"true"===i)),checked:this.disableGlobalScope,style:{marginLeft:"5%",marginBottom:"5px"},handlesEvents:{checkBoxDisplay:function(e,t){"user"!==e["Utils.AncestorPiAppFilter.projectScope"]||!0!==i&&"true"!==i?this.hide():this.show()},checkBoxDisplay1:function(e,t,i){!0===t&&"user"===e?this.show():this.hide()}}}];return(r=_.map(r,function(e){return _.merge(e,this.settingsConfig)},this)).concat(e||[])},_updateReleaseValues:function(){_.each(this.filterControls,function(e){_.each(e.inlineFilterButton.inlineFilterPanel.advancedFilterPanel.advancedFilterRows.rows,function(e){"Release"===e.name&&e._valueFieldIsValid()&&_.each(e.items.items,function(e){"rallyreleasecombobox"===e.xtype&&this._getRelease(e.originalValue).then(function(t){t&&(e.rawValue=t.Name)})},this)},this)},this)},_addAncestorControls:function(){var e={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"},t=this.ownerLabelWidth;this.cmp.getWidth()<this.singleRowMinWidth&&(e="vbox",t=this.ancestorLabelWidth);var i={xtype:"container",id:"controlsArea",overflowX:"auto",layout:{type:"hbox",align:"top"},items:[{xtype:"container",id:"pubSubIndicatorArea",width:25,padding:"6 5 0 0",hidden:!this.publisher&&!this._isSubscriber(),items:[{xtype:"component",id:"publisherIndicator",html:'<span class="icon-bullhorn icon-large"></span>',hidden:!this.publisher},{xtype:"component",id:"subscriberIndicator",html:'<span class="icon-link icon-large"></span>',hidden:!this._isSubscriber()}]},{xtype:"container",id:"filtersArea",layout:e,items:[{xtype:"container",id:"ancestorFilterArea",layout:{type:"hbox",align:"middle"},items:[{xtype:"container",id:"piTypeArea",layout:{type:"hbox",align:"middle"}},{xtype:"container",id:"piSelectorArea",itemId:"piSelectorArea",layout:{type:"hbox",align:"middle",padding:"0 0 0 5"}}]}]}]};let s={...this.cmp.defaultSettings,...this.cmp.getSettings()};return this.renderArea&&(this.renderArea.setOverflowXY("auto","auto"),this.renderArea.add(i),this._isSubscriber()||!0===s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]||"true"===s["Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter"]||this.renderArea.down("#filtersArea").add({xtype:"container",itemId:"scopeControlArea",id:"scopeControlArea",width:this._showIgnoreProjectScopeControl()?250:0,margin:this._showIgnoreProjectScopeControl()?"0 10 0 0":0,layout:{type:"hbox",align:"middle"},items:[{xtype:"multifilterscopecontrol",stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),labelStyle:this.labelStyle,labelWidth:this._showIgnoreProjectScopeControl()?t:0,fieldLabel:this.ownerOnlyLabel,storeConfig:{fields:["text","value"],data:[{text:"Current Project(s)",value:"current"},{text:"Any Project",value:"workspace"}]},listeners:{scope:this,change:function(){this._onSelect()}}}]}),this.filterHelpBtn=Ext.widget("rallybutton",{itemId:"filterHelpBtn",floating:!0,shadow:!1,cls:"filter-help",iconOnly:!0,iconCls:"icon-help",hidden:this._isSubscriber()||!this._showMultiLevelFilter(),handler:(...e)=>this.onHelpClicked(...e)}),this.filterHelpBtn.showBy(this.renderArea,"tr-tr",[-4,5])),this._addTooltips(),new Promise(function(e){!this._isSubscriber()&&this._showAncestorFilter()?this._addPiTypeSelector().then(function(){this._addPiSelector(this.piTypeSelector.getValue(),null).then(function(){e()}.bind(this))}.bind(this)):e()}.bind(this))},_addPiTypeSelector:function(e){return new Promise(function(t){this.piTypeSelector=Ext.create("Rally.ui.combobox.PortfolioItemTypeComboBox",{xtype:"rallyportfolioitemtypecombobox",id:"Utils.AncestorPiAppFilter.piType",name:"Utils.AncestorPiAppFilter.piType",width:250,plugins:[],stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piType"),stateEvents:["select"],fieldLabel:this.ancestorLabel,labelWidth:this.ancestorLabelWidth,labelStyle:this.labelStyle,valueField:"TypePath",value:e||this._defaultPortfolioItemType(),allowNoEntry:!1,defaultSelectionPosition:"first",listeners:{scope:this,ready:function(e){e.addListener({scope:this,change:this._onPiTypeChange}),t()}}}),this.renderArea.down("#piTypeArea").add(this.piTypeSelector)}.bind(this))},_addTooltips:function(){Ext.tip.QuickTipManager.register({target:"publisherIndicator",text:'This app broadcasts filter settings to any enabled ancestor filtered apps (indicated with <span class="icon-link icon-large"></span>)',showDelay:50,border:!0}),Ext.tip.QuickTipManager.register({target:"subscriberIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0}),this._isSubscriber()&&Ext.tip.QuickTipManager.register({target:"subscriberFilterIndicator",text:'This app listens for filter settings from any enabled ancestor filter broadcast app (indicated with <span class="icon-bullhorn icon-large"></span>)',showDelay:50,border:!0})},_onCmpResize:function(e,t){var i={type:"hbox",align:"middle",defaultMargins:"0 10 0 0"};t<this.singleRowMinWidth&&(i={type:"vbox"});var s=this.renderArea.down("#filtersArea");if(s){var r=this.renderArea.down("#controlsArea"),l={xtype:"container",id:"filtersArea",layout:i,items:s.removeAll(!1),hidden:s.isHidden()};r.remove(s,!1),r.add(l)}},_hideControlCmp:function(){this.renderArea&&(this.renderArea.down("#pubSubIndicatorArea").show(),this.renderArea.down("#subscriberIndicator").show(),this.renderArea.down("#filtersArea").hide())},_onPiTypeChange:function(e,t){if(t){let e=this._getValue().pi;this._removePiSelector(),this._addPiSelector(t).then(function(){e&&this._onSelect()}.bind(this))}},_removePiSelector:function(){this.piSelector=null,this.renderArea.down("#piSelectorArea").removeAll(!0)},_addPiSelector:function(e,t){return new Promise(function(i){this.piSelector=Ext.create("Rally.ui.combobox.ArtifactSearchComboBox",{id:"Utils.AncestorPiAppFilter.piSelector",width:250,margin:"0 10 0 10",labelAlign:"top",storeConfig:{models:e,autoLoad:!0,fetch:this.defaultFetch,context:{project:null}},queryDelay:2e3,typeAhead:!1,validateOnChange:!1,stateful:!0,stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.piSelector"),stateEvents:["select"],valueField:"_ref",allowClear:!0,clearValue:null,allowNoEntry:this.allowNoEntry,noEntryValue:"",value:t||null,defaultSelectionPosition:null,listeners:{scope:this,select:function(){this._onSelect()},ready:function(){i()}}}),Ext.override(this.piSelector,{saveState:function(){var e,t=this,i=t.stateful&&t.getStateId(),s=t.hasListeners;i&&(e=t.getState()||{},s.beforestatesave&&!1===t.fireEvent("beforestatesave",t,e)||(Ext.state.Manager.set(i,e),s.statesave&&t.fireEvent("statesave",t,e)))}}),this.renderArea.down("#piSelectorArea").add(this.piSelector)}.bind(this))},_setPiSelector:function(e,t){return new Promise(function(i){this.piTypeSelector?(this.piTypeSelector.suspendEvents(!1),this.piTypeSelector.setValue(e),this._removePiSelector(),this._addPiSelector(e,t).then(function(){this.piSelector.setValue(t),this.piTypeSelector.resumeEvents(),i()}.bind(this))):i()}.bind(this))},_showAncestorFilter:function(){let e=this.cmp.getSetting("Utils.AncestorPiAppFilter.enableAncestorPiFilter2");return void 0!==e&&e},_showIgnoreProjectScopeControl:function(){return"user"===(this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope)},_ignoreProjectScope:function(){let e;return this._isSubscriber()?"workspace"===(e=this.publishedValue.scope)||"specific"===e&&this.publishedValue.projects&&!!this.publishedValue.projects.length:"specific"===(e=this._showIgnoreProjectScopeControl()?this.cmp.down("#ignoreScopeControl")&&this.cmp.down("#ignoreScopeControl").getValue():this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope)&&this.projectPicker&&!!this.projectPicker.getValue().length||"workspace"===e&&!this.disableGlobalScope},_isSubscriber:function(){return this.isSubscriber},_defaultPortfolioItemType:function(){return this.cmp.getSetting("Utils.AncestorPiAppFilter.defaultPiType")},_getPropertyPrefix:function(e,t){let i,s=e.toLowerCase();return"hierarchicalrequirement"===s||"userstory"===s?i=this.getLowestPortfolioItemType().get("Name"):"defect"===s?(i="Requirement",(t=t.slice(1)).length&&(i+=`.${this.getLowestPortfolioItemType().get("Name")}`)):"testcase"===s?(i="WorkProduct",(t=t.slice(1)).length&&(i+=`.${this.getLowestPortfolioItemType().get("Name")}`)):Ext.String.startsWith(s,"portfolioitem")&&(i="Parent"),i&&_.forEach(t.slice(1),function(){i+=".Parent"},this),i},_getAncestorTypeArray:function(e,t){var i,s,r=e.toLowerCase(),l=t.toLowerCase();return"testcase"===r?(i=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===l}),this.allTypes.slice(0,i+1)):(s=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===r}))<(i=_.findIndex(this.allTypes,function(e){return e.get("TypePath").toLowerCase()===l}))?this.allTypes.slice(s+1,i+1):null},_showMultiLevelFilter:function(){let e=this.cmp.getSetting("Utils.MultiLevelPiAppFilter.enableMultiLevelPiFilter");return void 0===e?this.displayMultiLevelFilter:e},_addFilters:function(){return new Promise(function(e,t){var i=[];this._showMultiLevelFilter()&&!this._isSubscriber()?this.btnRenderArea?this._isSubscriber()?(this.btnRenderArea.add({xtype:"container",id:"filterSubIndicatorArea",width:25,padding:"6 5 0 0",items:[{xtype:"component",id:"subscriberFilterIndicator",html:'<span class="icon-link icon-large"></span>'}]}),e()):(this.showFiltersBtn=this.btnRenderArea.add({xtype:"multifiltertogglebtn",cls:` rly-small ${this.filtersHidden?"secondary":"primary"}`,handler:this._toggleFilters,scope:this,stateId:this.cmp.getContext().getScopedStateId("multi-filter-toggle-button"),listeners:{scope:this,added:function(e){this.filtersHidden&&e.setFiltersHidden(!0),e.filtersHidden?e.setToolTipText("Show Filters"):e.setToolTipText("Hide Filters")}}}),Rally.data.ModelFactory.getModels({types:this._getAllTypePaths().reverse(),context:this.cmp.getContext(),scope:this,success:function(t){this.models=t,this.tabPanel=this.panelRenderArea.add({xtype:"tabpanel",itemId:"multiLevelFilterTabPanel",width:"98%",cls:"blue-tabs",minTabWidth:75,plain:!0,autoRender:!0,hidden:this._isSubscriber()||this.showFiltersBtn.filtersHidden,hideMode:"offsets",items:[]}),this.filterControls=[];let s={},r={},l=1,o={blackListFields:this.blackListFields,whiteListFields:this.whiteListFields},n=this.cmp.getContext();this.cmp.getWidth()<this.singleRowMinWidth&&(s={text:"Clear"},r={fieldLabel:"Match",width:65},o.width=100,l=2);let a={},c=Object.keys(t).length;if(this.visibleTab)for(let e=0;e<c;e++)a[e]=c-e-1;_.each(t,function(e,t){if(this._addStoryAndDefectFiltersToModels(e,t),this.visibleTab&&this.visibleTab.toLowerCase()===t.toLowerCase())if("Defect"===this.visibleTab)this.defaultTab=a[0]+1;else{let t=e.ordinal;if("number"==typeof t){let e=a[t+1];"number"==typeof e&&(this.defaultTab=e)}}i.push(new Promise(function(i){let a=`inlineFilter${t}`;this.filterControls.push(Ext.create("Rally.ui.inlinefilter.InlineFilterControl",{xtype:"rallyinlinefiltercontrol",name:a,autoRender:!0,itemId:a,context:n,inlineFilterButtonConfig:{stateful:!0,stateId:this.cmp.getContext().getScopedStateId(`multi-${a}-button`),stateEvents:["inlinefilterchange"],context:this.cmp.getContext(),modelNames:t,filterChildren:this.filterChildren,inlineFilterPanelConfig:{autoRender:!0,name:`${a}-panel`,itemId:`${a}-panel`,model:e,padding:5,width:"98%",context:n,quickFilterPanelConfig:{defaultFields:this.defaultFilterFields,addQuickFilterConfig:{whiteListFields:this.whiteListFields,blackListFields:this.blackListFields}},advancedFilterPanelConfig:{collapsed:this.advancedFilterCollapsed,advancedFilterRowsConfig:{propertyFieldConfig:o,flex:l},matchTypeConfig:r,clearAdvancedButtonConfig:s}},listeners:{inlinefilterchange:this._onFilterChange,inlinefilterready:function(e){this._onFilterReady(e),i()},scope:this}}}))}.bind(this)))},this),Promise.all(i).then(async function(){this._isSubscriber()||(await this.addProjectPicker(),this.clearAllButton=Ext.widget({xtype:"rallybutton",itemId:"clearAllButton",cls:"secondary rly-small clear-all-filters-button",text:"Clear All",margin:"3 9 3 0",hidden:!this._hasFilters(),listeners:{click:()=>this._clearAllFilters(!1),scope:this}}),this.btnRenderArea.add(this.clearAllButton),this.tabPanel.setActiveTab(this.defaultTab),this.filtersHidden&&this.tabPanel.hide(),this.btnRenderArea.setOverflowXY("auto","auto")),e()}.bind(this))},failure:function(){t("Failed to fetch models for multi-level filter")}})):t("Unable to find button render area for multi-level filter"):e()}.bind(this))},_addStoryAndDefectFiltersToModels:function(e,t){t===this.getLowestPortfolioItemType().get("TypePath")?(Rally.data.wsapi.ModelBuilder._addArtifactFieldToModel(e,"Blocked","HasStories"),e.getField("HasStories").displayName="Has Stories"):"HierarchicalRequirement"===t&&(Rally.data.wsapi.ModelBuilder._addArtifactFieldToModel(e,"Blocked","HasDefects"),e.getField("HasDefects").displayName="Has Defects")},_clearAllFilters:function(e){this.suspendEvents(!1);let t=this.tabPanel.getActiveTab();_.each(this.filterControls,function(e){try{this.tabPanel.setActiveTab(e.tab),e.inlineFilterButton.suspendEvents(!1),e.inlineFilterButton.clearAllFilters(),e.inlineFilterButton.saveState(),e.inlineFilterButton.resumeEvents(),this.projectPicker&&this.projectPicker.reset()}catch(e){console.log(e)}}.bind(this)),this.tabPanel.setActiveTab(t),this.resumeEvents(),e||this._onFilterChange()},_hasFilters:function(){var e=this.getMultiLevelFilters(),t=!1;return _.each(e,function(e){e.length&&(t=!0)}),this.projectPicker&&!1===t&&this.projectPicker.getValue().length>0&&(t=!0),t},_onFilterReady:function(e){e.expand();let t=e.quickFilterPanel.getFilters().length+e.advancedFilterPanel.getFilters().length,i=this._getModelName(e),s=this.tabPanel.add({title:i+(t?` (${t})`:""),html:"",itemId:`${i.replace(/\s+/g,"")}-tab`});s.add({xtype:"container",layout:"hbox",items:[e]}),e.tab=s},_getModelName(e){let t=e&&e.model&&e.model.elementName||"unknown";return"HierarchicalRequirement"===t&&(t=e.model.displayName),t},_applyFilters:function(){this.suspendEvents(!1),this.suspendLayouts(),_.each(this.filterControls,function(e){e.inlineFilterButton._applyFilters()}),this.resumeEvents(),this.resumeLayouts(!1),this.updateLayout()},_onFilterChange:function(){this.clearAllButton&&(this._hasFilters()?this.clearAllButton.show():this.clearAllButton.hide()),_.each(this.filterControls,function(e){if(e.inlineFilterButton.inlineFilterPanel){let t=this._getModelName(e.inlineFilterButton.inlineFilterPanel);this._setTabText(t,e.inlineFilterButton.getFilters().length)}},this),this.ready&&this.fireEvent("change",this.getMultiLevelFilters())},_setTabText:function(e,t){var i=t?`${e} (${t})`:e,s=this.tabPanel.child(`#${e.replace(/\s+/g,"")}-tab`);s&&s.setTitle(i)},_toggleFilters:function(e){this.tabPanel.isHidden()?(this.tabPanel.show(),e.setToolTipText("Hide Filters"),e.addCls("primary"),e.removeCls("secondary"),e.setFiltersHidden(!1)):(this.tabPanel.hide(),e.setToolTipText("Show Filters"),e.addCls("secondary"),e.removeCls("primary"),e.setFiltersHidden(!0))},_getAllTypePaths:function(){return _.map(this.allTypes,e=>e.get("TypePath"))},_showError(e,t){Rally.ui.notify.Notifier.showError({message:this.parseError(e,t)})},parseError(e,t){if(t=t||"An unknown error has occurred","string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:e.exception&&e.error&&"string"==typeof e.error.statusText&&!e.error.statusText.length&&e.error.status&&524===e.error.status?"The server request has timed out":t},onHelpClicked(){CustomAgile.ui.tutorial.MultiLevelFilterTutorial.showWelcomeDialog(this)},addProjectPicker(){return new Promise(e=>{let t=this.tabPanel.insert(0,{title:"Projects",itemId:"projectsTab",id:"projectsTab",padding:10}),i={...this.cmp.defaultSettings,...this.cmp.getSettings()};var s=[];"user"===i["Utils.AncestorPiAppFilter.projectScope"]&&("true"===i["Utils.MultiLevelPiAppFilter.projectScope.dropdownCurrent"]&&s.push({text:"Current Project(s)",value:"current"}),"true"!==i["Utils.MultiLevelPiAppFilter.projectScope.dropdownAny"]||this.disableGlobalScope||s.push({text:"Any Project",value:"workspace"}),"true"===i["Utils.MultiLevelPiAppFilter.projectScope.dropdownSpecific"]&&s.push({text:"Specific Project(s)",value:"specific"})),t.add({xtype:"container",itemId:"scopeControlArea",id:"scopeControlArea",width:this._showIgnoreProjectScopeControl()?250:0,margin:this._showIgnoreProjectScopeControl()?"0 10 0 0":0,layout:{type:"hbox",align:"middle"},items:[{xtype:"multifilterscopecontrol",stateId:this.cmp.getContext().getScopedStateId("Utils.AncestorPiAppFilter.ignoreProjectScopeControl"),labelStyle:this.labelStyle,labelWidth:this._showIgnoreProjectScopeControl()?this.ownerLabelWidth:0,fieldLabel:this.ownerOnlyLabel,storeConfig:{fields:["text","value"],data:s},listeners:{scope:this,change:function(){this._onScopeChange()}}}]}),this.projectPicker=t.add({xtype:"customagileprojectpicker",cmp:this.cmp,appName:"UtilsAncestorPiAppFilter",tab:t,listeners:{scope:this,ready:()=>e(),projectschanged:()=>{this.refreshProjects=!0},applyprojects:async()=>{this.projectsChanged=!0,"specific"===this.tabPanel.down("#ignoreScopeControl").getValue()?this._onChange():(this.projects=[],this.projectPicker.reset(),this.fireEvent("select",this))}}}),this.tabPanel.down("#ignoreScopeControl")&&("specific"!==this.tabPanel.down("#ignoreScopeControl").getValue()?this.hideShowProjectPicker("hide"):this.hideShowProjectPicker("show")),"user"!==i["Utils.AncestorPiAppFilter.projectScope"]&&t.tab.hide()})},getProjectScope(){return this._isSubscriber()?this.publishedValue.scope||"current":this._showIgnoreProjectScopeControl()?this.cmp.down("#ignoreScopeControl")&&this.cmp.down("#ignoreScopeControl").getValue()||"current":this.cmp.getSetting("Utils.AncestorPiAppFilter.projectScope")||this.projectScope},getProjects:async function(){return this._isSubscriber()?this.projects=this.publishedValue.projects||[]:this.projectsChanged&&await this.loadProjects(),this.projects},getProjectIDs:async function(){return await this.getProjects(),this.projects&&this.projects.length>0?_.map(this.projects,e=>e.get("_ref").replace("/project/","")):[]},getProjectRefs:async function(){return await this.getProjects(),this.projects&&this.projects.length>0?_.map(this.projects,e=>e.get("_ref")):[]},_updatePickerFromOldPicker:function(e,t){this.projectPicker&&this.projectPicker.updatePickerFromOldPicker(e,t)},hideShowProjectPicker(e){this.projectPicker&&"hide"===e?(this.projectPicker.projectPicker.hide(),this.projectPicker.down("#pheader").hide(),this.projectPicker.down("#includeChildProjectsCheckbox").hide()):(this.projectPicker.projectPicker.show(),this.projectPicker.down("#pheader").show(),this.projectPicker.down("#includeChildProjectsCheckbox").show(),this.useSpecificProjects()&&this.projectPicker.showApplyProjectsBtn())},_onScopeChange(){this.ready&&(this._showIgnoreProjectScopeControl()&&this.cmp.down("#ignoreScopeControl")&&"specific"===this.cmp.down("#ignoreScopeControl").getValue()?this.hideShowProjectPicker("show"):(this.hideShowProjectPicker("hide"),this.projectPicker&&this.projectPicker.showApplyProjectsBtn()))},async loadProjects(){this.projects=[],this._isSubscriber()?this.projects=this.publishedValue.projects||[]:this.useSpecificProjects()?await this._getSpecificProjectList():"workspace"!==this.getProjectScope()&&await this._getScopedProjectList(),this.projectsChanged=!1},useSpecificProjects(){return this._isSubscriber()?"specific"===this.publishedValue.scope&&this.publishedValue.projects&&this.publishedValue.projects.length:this._showIgnoreProjectScopeControl()&&this.cmp.down("#ignoreScopeControl")&&"specific"===this.cmp.down("#ignoreScopeControl").getValue()&&this.projectPicker&&!!this.projectPicker.getValue().length},async _getSpecificProjectList(){if(this.projectPicker){let e=this.projectPicker.getValue()||[];this.projectPicker.includeChildProjects()&&(e=await this._getAllChildProjects(e)),this.projects=e}else this.projects=[]},async _getAllParentProjects(e){let t=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","ObjectID","Parent"],filters:[{property:"ObjectID",value:e.get("Parent").ObjectID}],limit:1,pageSize:1,autoLoad:!1}),i=await t.load();if(i&&i.length){if(i[0].get("Parent")){let t=await this._getAllParentProjects(i[0]);return[e].concat(t)}return[e,i[0]]}return[e]},async _getAllChildProjects(e=[],t=["Name","Children","ObjectID"]){if(!e.length)return[];const i=e.map(e=>this.wrap(e.getCollection("Children",{fetch:t,limit:1/0,filters:[{property:"State",value:"Open"}]}).load())),s=_.flatten(await Promise.all(i)),r=await this._getAllChildProjects(s,t),l={};let o=_.flatten([...r,...e,...s]);return o.forEach(e=>l[e.get("_ref")]=e),o=Object.values(l)},async _getScopedProjectList(){let e=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","ObjectID","Children","Parent"],filters:[{property:"ObjectID",value:this.cmp.getContext().getProject().ObjectID}],limit:1,pageSize:1,autoLoad:!1}),t=await e.load(),i=[],s=[];t&&t.length?(this.cmp.getContext().getProjectScopeDown()&&(s=await this._getAllChildProjects(t)),this.cmp.getContext().getProjectScopeUp()&&(i=await this._getAllParentProjects(t[0])),s.length?t=s.concat(i.slice(1)):i.length&&(t=i),this.projects=t):this.projects=[]},async wrap(e){return e&&_.isFunction(e.then)?new Promise((t,i)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),i(e)},scope:this})}):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))}}),Ext.define("CustomAgile.ui.combobox.MultiFilterScopeControl",{extend:"Rally.ui.combobox.ComboBox",alias:"widget.multifilterscopecontrol",config:{itemId:"ignoreScopeControl",stateful:!0,stateEvents:["select"],displayField:"text",valueField:"value"},setValue:function(e){"boolean"==typeof e&&(e=e?"workspace":"current"),this.callParent(arguments)},applyState:function(e){this.store.loading?this.store.on("load",function(){this.setValue(e.value),this.saveState()},this,{single:!0}):this.setValue(e.value)}}),Ext.define("CustomAgile.ui.picker.MultiSelectTimebox",{extend:"Rally.ui.picker.MultiObjectPicker",alias:"widget.customagilemultiselecttimebox",config:{remoteFilter:!0,maxLength:100,projects:null,pickerCfg:{cls:"multiselect-timebox-picker",minWidth:350},width:150,enableGrouping:!1,toggleOnClick:!0,timeboxStartDateField:"",timeboxEndDateField:""},initComponent(){Rally.ui.list.PagingToolbar.prototype.emptyMsg="No timeboxes",this.callParent(arguments),this.store||this.createStore()},triggerBlur(){const{picker:e}=this;e&&e.isVisible()&&(this.collapse(),this.callParent(arguments))},getMatchedTextHtml:e=>`<div class="timebox-name">${e.Name}</div>`,resetFilters(){},setValueBasedOnState(e=[]){const t=Ext.isString(e)?e.split(","):Ext.Array.from(e);!_.isEmpty(t)&&this.store&&this.store.isLoading()?this.store.on("load",()=>{this._selectValues(t)},this,{single:!0}):this._selectValues(t),this.isExpanded&&(this._onListRefresh(),this._groupSelectedRecords()),this.fireEvent("stateapplied",this,this.selectedValues.getRange(),null)},setDefaultValue(e){this._selectValues(e),this.fireEvent("defaultapplied",this,this.selectedValues.getRange(),null)},getTimeboxOidsInScope(e,t,i){if(e.length>0){let s={model:Ext.identityFn(this.modelType),filters:this._getTimeboxFilters(e),fetch:["Name",this.timeboxStartDateField,this.timeboxEndDateField,"ObjectID"],autoLoad:!0,listeners:{load:(e,s)=>{Ext.callback(t,i,[s])}}};this.projects&&(s.filters=s.filters.and({property:"Project.ObjectID",operator:"in",value:this.projects}),s.context={project:null}),Ext.create("Rally.data.wsapi.Store",s)}else Ext.callback(t,i,[[]])},_getTimeboxFilters(e){let t=[],i={};return _.each(e,e=>{let s=`${e.get("Name")}-${e.get(this.timeboxStartDateField)}-${e.get(this.timeboxEndDateField)}`;if(!i[s]){i[s]=!0;let r=Rally.data.wsapi.Filter.and([{property:"Name",value:e.get("Name")},{property:this.timeboxStartDateField,value:e.get(this.timeboxStartDateField)},{property:this.timeboxEndDateField,value:e.get(this.timeboxEndDateField)}]);t.push(r)}}),Rally.data.wsapi.Filter.or(t)},createStore(){if(!this.store){let e=Ext.create("Rally.data.DataStoreBuilder"),t=Ext.merge({model:this.modelType,requester:this},this.storeConfig);return e.build(t).then({success(e){this.store=e,this.relayEvents(this.store,["datachanged"])},scope:this})}return Promise.resolve(this.store)},_initInputEvents(){this.rendered?(this.on("expand",this.refreshView,this),this.mon(this.inputEl,"keydown",this._onInputKeyDown,this,{buffer:700}),this.mon(this.inputEl,"keyup",this.validate,this,{buffer:700}),this.mon(this.inputEl,"keyup",this._onInputKeyUp,this,{buffer:700})):this.on("afterrender",this._initInputEvents,this,{single:!0})},_onInputTextChanged(){this.store.clearFilter(),this.store.filter({anyMatch:!0,exactMatch:!1,property:"Name",value:this.getInputTextValue()}),this.store.load()},_onInputKeyUp(e){this._setAppropriateEmptyText(),!e.shiftKey&&Rally.util.Event.isModifierKey(e)||this._onInputTextChanged(),""===this.getInputTextValue()&&(this.store.filters&&this.store.filters.clear(),this.store.load())},_createList(){this.listCfg.pageSize=10;let e=Ext.apply({store:this.store,tpl:this._getListTpl(),createPagingToolbar:Ext.bind(this._createPagingToolbar,this)},this.listCfg);return this.list=Ext.create(this.listType,e),this.mon(this.list,{refresh:this._onListRefresh,select:this.onListItemSelect,deselect:this.onListItemDeselect,scope:this}),this.getList().down("rallylistpagingtoolbar").onLoad(),this.list},onListItemSelect(e,t){this.select(t),this._selectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.refreshView(),this.fireEvent("select",this,t,this.getValue()),this._fireSelectionChange()},onListItemDeselect(e,t){let i=null;const s=this._getKey(t);this.selectedValues.each(e=>{e.get("_ref")===s&&(i=e)}),i&&this.selectedValues.remove(i),this._syncSelection(),this._deselectRowCheckbox(t.get(this.recordKey)),this._groupRecordsAndScroll(this._getRecordValue()),this.fireEvent("deselect",this,t,this.getValue()),this._fireSelectionChange()},_deselectRowCheckbox(e){this._getOptionCheckbox(e)&&this._getOptionCheckbox(e).removeCls("rui-picker-cb-checked")},_onStoreLoaded(){this._syncSelection(),this.callParent(arguments)},_createPagingToolbar(){return Ext.widget("rallylistpagingtoolbar",{store:this.store,border:!1,layout:{align:"middle"}})}}),Ext.define("CustomAgile.ui.picker.MultiSelectProject",{extend:"CustomAgile.ui.picker.MultiSelectTimebox",alias:"widget.customagilemultiselectproject",requires:["CustomAgile.ui.picker.MultiSelectTimebox"],config:{modelType:"Project",emptyText:"Search projects...",storeConfig:{autoLoad:!0,limit:10,pageSize:10,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name"],sorters:[{property:"Name",direction:"ASC"}],context:{project:null}}},initComponent(){this.callParent(arguments),Rally.ui.list.PagingToolbar.prototype.emptyMsg=`No ${this.modelType}s`},getFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("_ref"))}},getLookbackFilter(){let e=this.getValue();return{property:"Project",operator:"in",value:_.map(e,e=>e.get("ObjectID"))}}}),Ext.define("Customagile.ui.PillPicker",{extend:"Ext.Container",alias:"widget.customagilepillpicker",pickerCfg:null,showPills:!0,statefulKey:null,sharedSchedules:!1,defaultToRecentTimeboxes:!0,initComponent(){let e=[];if(this.recordsToAdd=[],this.picker=Ext.ComponentManager.create(this.pickerCfg),this.mon(this.picker,"selectionchange",this._onSelectionChange,this),this.mon(this.picker,"select",this._onItemSelect,this),this.mon(this.picker,"deselect",this._onItemDeselect,this),this.mon(this.picker,"expand",this._onInitialExpand,this,{single:!0}),this.items=this._createItems(),this.statefulKey&&(e=JSON.parse(localStorage.getItem(this.statefulKey))),e&&e.length>0)Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.sharedSchedules?this.picker.getTimeboxOidsInScope(e,e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults()},this):(this.recordsToAdd=e,this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e))},scope:this});else if(this.sharedSchedules){const e=this.picker.store.getRange(0,9);this.defaultToRecentTimeboxes?(this.recordsToAdd=e,this.picker.setDefaultValue(e)):(this.recordsToAdd=[],this.picker.setValueBasedOnState([]))}else this.picker.createStore().then(()=>{this.mon(this.picker,"datachanged",this._onInitialDataChanged,this,{single:!0}),this.picker.setDefaultValue([])},e=>{console.log(e),this.picker.setDefaultValue([])});this.callParent(arguments),this.sharedSchedules&&this._addPills(this.recordsToAdd)},getValue(){const{picker:e}=this;return e?e.getValue():[]},getFilter(){return this.picker&&this.picker.getFilter()},getLookbackFilter(){return this.picker&&this.picker.getLookbackFilter()},saveStateLocal(e){if(this.statefulKey)try{localStorage.setItem(this.statefulKey,JSON.stringify(_.invoke(e,"get","_ref")))}catch(e){}},_onInitialDataChanged(){this._setDefaults()},_setDefaults(){0===this.recordsToAdd.length&&(this.defaultToRecentTimeboxes?Ext.create("Rally.data.wsapi.Store",{model:"Release",autoLoad:!0,limit:4,pageSize:4,remoteSort:!0,remoteFilter:!0,fetch:["ObjectID","Name","ReleaseStartDate","ReleaseDate"],sorters:[{property:"ReleaseDate",direction:"DESC"}],filters:[{property:"ReleaseStartDate",operator:"<",value:new Date}],context:{project:Rally.getApp().getContext().getProjectRef(),projectScopeUp:!1,projectScopeDown:!1},listeners:{scope:this,load:function(e,t,i){i?(this.picker.setDefaultValue(t),this._addPills(t)):this.picker.setDefaultValue([])}}}):this.picker.setValueBasedOnState([]))},_onInitialExpand(){this.picker.getList()&&(this.picker.getList().pagingToolbar.onLoad(),this.picker.getList().refresh())},_addPills(e){let t=e;if(!this.showPills)return;if(this.sharedSchedules){let i={};t=_.filter(e,e=>{let t=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return!i[t]&&(i[t]=!0,!0)})}const i=_.map(t,e=>({xtype:"component",flex:1,itemId:`pill-id-${e.getId()}`,renderTpl:'<span class="tagPill">{Name}<span class="icon-cancel"></span></span>',renderData:e.getData(),renderSelectors:{tagPill:".tagPill",removePillEl:".icon-cancel"},listeners:{click:{element:"tagPill",fn:t=>{t.preventDefault(),this._onRemovePillClick(e)},scope:this}}}),this),s=_.filter(i,e=>_.isEmpty(this.down(`#${e.itemId}`)),this);s.length>0&&this.down("#pillContainer").add(s)},_createItems(){return[this.picker,{itemId:"pillContainer",xtype:"container",cls:"pill-select-container",margin:"10 0 0 0",layout:{type:"table",columns:3}}]},_removePills(){_.each(this.down("#pillContainer").items.getRange(),e=>{e.destroy()})},_removePill(e){let t=this.down(`#pill-id-${e.getId()}`);t&&t.destroy()},_onSelectionChange(e,t){Ext.suspendLayouts(),this._removePills(),this._addPills(t),Ext.resumeLayouts(!0),this.saveStateLocal(t)},_onItemSelect(e,t){this._addPills(Ext.Array.from(t))},_onItemDeselect(e,t){this._removePill(t)},_findSharedSchedules(e){const t=this.picker.selectedValues.getRange(),i=`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`;return _.filter(t,e=>{return`${e.get("Name")}-${e.get(this.startDateFieldName)}-${e.get(this.endDateFieldName)}`===i})},_onRemovePillClick(e){if(this.sharedSchedules){const t=this._findSharedSchedules(e);_.each(t,e=>{this.picker.onListItemDeselect(null,e),this._removePill(e)})}else this.picker.onListItemDeselect(null,e),this._removePill(e);this.saveStateLocal(this.picker.selectedValues.getRange()),this.fireEvent("recordremoved",this.picker.selectedValues,e,this.picker)},_setPillsFromPrjRef(e){return new Promise(t=>{Ext.create("Rally.data.wsapi.RefsToRecords").convert(e,{requester:this}).then({success:e=>{this.recordsToAdd=e,e&&e.length>0?(this.picker.setValueBasedOnState(e),this._addPills(e),this.saveStateLocal(e)):this._setDefaults(),t()},failure:e=>{console.log(e),t()},scope:this})})}}),Ext.define("Customagile.ui.ProjectPicker",{extend:"Ext.Container",alias:"widget.customagileprojectpicker",layout:"vbox",cmp:null,appName:"",tab:null,initComponent(){this.callParent(arguments),this.add([{xtype:"component",html:"If you require a report spanning across multiple project hierarchies, use this project picker to specify where the data will be pulled from. If blank, app will respect user's current project scoping.",itemId:"pheader",cls:"x-form-item-label"},{xtype:"customagilepillpicker",itemId:"projectPicker",hidden:!1,statefulKey:this.cmp.getContext().getScopedStateId(this.appName+"-project-picker"),defaultToRecentTimeboxes:!1,listeners:{recordremoved:this.showApplyProjectsBtn,scope:this},pickerCfg:{xtype:"customagilemultiselectproject",width:350,margin:"10 0 0 0",listeners:{stateapplied:()=>this._onReady(),defaultapplied:()=>this._onReady(),blur:this.showApplyProjectsBtn,scope:this}}},{xtype:"rallycheckboxfield",itemId:"includeChildProjectsCheckbox",fieldLabel:"Show work from child projects",labelSeparator:"",stateful:!0,stateId:this.cmp.getContext().getScopedStateId(this.appName+"-scope-down-checkbox"),stateEvents:["change"],labelWidth:200,listeners:{scope:this,change:this.showApplyProjectsBtn}},{xtype:"rallybutton",itemId:"applyProjectsBtn",text:"Apply",margin:"10 0 0 0",hidden:!0,handler:function(e){e.hide(),this.fireEvent("applyprojects")}.bind(this)}]),this.projectPicker=this.down("#projectPicker")},_onReady(){setTimeout(()=>this.updateProjectTabText(),1e3),this.fireEvent("ready")},showApplyProjectsBtn(){this.down("#applyProjectsBtn")&&this.down("#applyProjectsBtn").show(),this.updateProjectTabText(),this.fireEvent("projectschanged")},updateProjectTabText(){if(this.tab)if(this.cmp.down("#ignoreScopeControl")&&"workspace"===this.cmp.down("#ignoreScopeControl").getValue())this.tab.setTitle("PROJECTS (ALL)");else if(this.projectPicker&&!this.projectPicker.hidden){let e=this.projectPicker.getValue().length,t=e?`PROJECTS (${e})`:"PROJECTS";this.tab.setTitle(t)}else this.tab.setTitle("PROJECTS")},getValue(){return this.projectPicker.getValue()},includeChildProjects(){return this.down("#includeChildProjectsCheckbox").getValue()},setIncludeChildProjects(e){this.down("#includeChildProjectsCheckbox").setValue(e)},reset(){this.projectPicker._removePills(),this.projectPicker.picker.setValueBasedOnState([]),this.projectPicker.saveStateLocal([]),this.updateProjectTabText(),this.down("#includeChildProjectsCheckbox").setValue(!1),this.projectPicker.picker.setDefaultValue([]),this.down("#applyProjectsBtn")&&this.down("#applyProjectsBtn").hide()},getProjectRefs(){return _.map(this.projectPicker.getValue(),e=>e.get("_ref"))},async setValueFromPrjRef(e,t){this.setIncludeChildProjects(t),await this.projectPicker._setPillsFromPrjRef(e)},async updatePickerFromOldPicker(e,t){let i=JSON.parse(localStorage.getItem(this.cmp.getContext().getScopedStateId(e+"-project-picker")));i&&i.length>0&&(await this.setValueFromPrjRef(i,t),localStorage.removeItem(this.cmp.getContext().getScopedStateId(e+"-project-picker")))}});
                Ext.define("CustomAgile.ui.renderer.RecordFieldRendererFactory",{singleton:!0,colorPalette:{"#105cab":"Dark Blue","#21a2e0":"Blue","#107c1e":"Green","#4a1d7e":"Purple","#df1a7b":"Pink","#ee6c19":"Burnt Orange","#f9a814":"Orange","#fce205":"Yellow","#848689":"Grey"},getFieldDisplayValue:function(e,t,r,a){if(!e||!t)return"";let o=e.get?e.get(t):e[t],s=r||", ";return _.isUndefined(o)||null===o?o="":"boolean"==typeof o?o=o.toString():Ext.isDate(o)?o=Rally.util.DateTime.formatWithDefaultDateTime(o):"DisplayColor"===t?o=this.colorPalette[o]||o:"Parent"===t?o=o&&o.FormattedID&&o.Name&&o.FormattedID+": "+o.Name||o._refObjectName||e.get("Feature")&&(e.get("Feature").FormattedID&&e.get("Feature").Name&&e.get("Feature").FormattedID+": "+e.get("Feature").Name||e.get("Feature")._refObjectName)||"No Parent":"Release"===t?o=o&&o.Name||"Unscheduled":"Project"===t?o=o&&o.Name||"Failed to convert project field":"Predecessors"===t||"Successors"===t?o="object"==typeof o&&"number"==typeof o.Count?o.Count:"":"PredecessorsAndSuccessors"===t?o="number"==typeof o.Predecessors?`Predecessors: ${o.Predecessors}; Successors: ${o.Successors}`:"":"Owner"===t||"CreatedBy"===t?(o=o.DisplayName||o.FirstName&&o.LastName&&`${o.FirstName} ${o.LastName}`||o._refObjectName)||"Owner"!==t||(o="No Owner"):"PreliminaryEstimate"===t?o=`${o.Name} (${o.Value})`:"Milestones"===t?o=o.Count?(o=_.map(o._tagsNameArray,e=>`${e.FormattedID}: ${e.Name}`)).join(s):"None":t.toLowerCase().indexOf("portfolioitem/")>-1||"Feature"===t?o=o&&`${o.FormattedID}: ${o.Name}`||"None":"object"==typeof o?o=o._tagsNameArray?(o=_.map(o._tagsNameArray,e=>e.Name||e.Value)).join(s):o.Name||o.value||o._refObjectName||"Unable to convert field for export":_.isArray(o)&&(o=o.join(s)),a&&(o=this.cleanseExportValue(o.toString())),o},cleanseExportValue(e){let t=new RegExp("</?[^>]+>","gi"),r=new RegExp("&nbsp;","gi");return t.test(e)&&(e=e.replace("<br>","\r\n"),e=Ext.util.Format.htmlDecode(e),e=Ext.util.Format.stripTags(e)),e=e.replace(r," ")}});
                var saveAs=saveAs||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=function(){return e.URL||e.webkitURL||e},n=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in n,r=/constructor/i.test(e.HTMLElement)||e.safari,a=/CriOS\/[\d]+/.test(navigator.userAgent),i=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},d=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},s=function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){i(e)}}},f=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},u=function(i,u,c){c||(i=f(i));var l,p=this,v="application/octet-stream"===i.type,w=function(){s(p,"writestart progress write writeend".split(" "))};if(p.readyState=p.INIT,o)return l=t().createObjectURL(i),void setTimeout(function(){var e,t;n.href=l,n.download=u,e=n,t=new MouseEvent("click"),e.dispatchEvent(t),w(),d(l),p.readyState=p.DONE});!function(){if((a||v&&r)&&e.FileReader){var n=new FileReader;return n.onloadend=function(){var t=a?n.result:n.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,p.readyState=p.DONE,w()},n.readAsDataURL(i),void(p.readyState=p.INIT)}l||(l=t().createObjectURL(i)),v?e.location.href=l:e.open(l,"_blank")||(e.location.href=l);p.readyState=p.DONE,w(),d(l)}()},c=u.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=f(e)),navigator.msSaveOrOpenBlob(e,t)}:(c.abort=function(){},c.readyState=c.INIT=0,c.WRITING=1,c.DONE=2,c.error=c.onwritestart=c.onprogress=c.onwrite=c.onabort=c.onerror=c.onwriteend=null,function(e,t,n){return new u(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});
                Ext.define("CArABU.technicalservices.FileUtilities",{singleton:!0,saveCSVToFile:function(e,t,r){void 0==r&&(r={type:"text/csv;charset=utf-8"});var o=new Blob([e],r);saveAs(o,t)},saveTextAsFile:function(e,t){var r=new Blob([e],{type:"text/plain"}),o=t,n=document.createElement("a");n.download=o,n.innerHTML="Download File",null!=window.webkitURL?n.href=window.webkitURL.createObjectURL(r):(n.href=window.URL.createObjectURL(r),n.onclick=destroyClickedElement,n.style.display="none",document.body.appendChild(n)),n.click()},destroyClickedElement:function(e){document.body.removeChild(e.target)},convertDataArrayToCSVText:function(e,t){var r="";return Ext.each(Object.keys(t),function(e){r+=t[e]+","}),r=r.replace(/,$/,"\n"),Ext.each(e,function(e){Ext.each(Object.keys(t),function(t){e[t]?"object"==typeof e[t]?e[t].FormattedID?r+=Ext.String.format('"{0}",',e[t].FormattedID):e[t].Name?r+=Ext.String.format('"{0}",',e[t].Name):isNaN(Date.parse(e[t]))?r+=Ext.String.format('"{0}",',e[t].toString()):r+=Ext.String.format('"{0}",',Rally.util.DateTime.formatWithDefaultDateTime(e[t])):r+=Ext.String.format('"{0}",',e[t]):r+=","},this),r=r.replace(/,$/,"\n")},this),r},_getCSVFromWsapiBackedGrid:function(e){for(var t=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.wsapi.Store",{fetch:e.getStore().config.fetch,filters:e.getStore().config.filters,model:e.getStore().config.model,limit:1/0,pageSize:1/0}),o=e.columns,n=this._getHeadersFromGrid(e),a=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),i=e.getStore().pageSize,c=Math.ceil(a/i),l=[],s=1;s<=c;s++)l.push(this.loadStorePage(e,r,o,s,c));return Deft.Promise.all(l).then({success:function(e){var r=[];r.push('"'+n.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGridWithPaging:function(e){var t=Ext.create("Deft.Deferred"),r=Ext.create("Rally.data.custom.Store",{model:e.getStore().config.model,filters:e.getStore().config.filters,limit:1/0,pageSize:1/0}),o=e.columns,n=this._getHeadersFromGrid(e),a=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),i=e.getStore().pageSize,c=Math.ceil(a/i),l=[];return l.push(this.loadStorePage(e,r,o,page,c)),Deft.Promise.all(l).then({success:function(e){var r=[];r.push('"'+n.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_getCSVFromCustomBackedGrid:function(e){var t=Ext.create("Deft.Deferred"),r=this;Rally.getApp().setLoading("Assembling data for export...");var o=this._getHeadersFromGrid(e),n=Ext.clone(e.getStore()),a=e.columns,i=(this._getColumnNamesFromGrid(e),e.getStore().getTotalCount()),c=e.getStore().pageSize,l=Math.ceil(i/2e4);n.pageSize=2e4;for(var s=[],d=[],u=1;u<=l;u++)s.push(u);return Ext.Array.each(s,function(t){d.push(function(){return r._loadStorePage(e,n,a,t,s.length)})}),Deft.Chain.sequence(d).then({success:function(e){n.pageSize=c,n.loadPage(1);var r=[];r.push('"'+o.join('","')+'"'),_.each(e,function(e){_.each(e,function(e){r.push(e)})}),r=r.join("\r\n"),t.resolve(r),Rally.getApp().setLoading(!1)}}),t.promise},_loadStorePage:function(e,t,r,o,n){var a=Ext.create("Deft.Deferred");return t.loadPage(o,{callback:function(r){for(var o=[],n=0;n<r.length;n++){var i=r[n];o.push(this._getCSVFromRecord(i,e,t))}a.resolve(o)},scope:this}),a.promise},_getHeadersFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&(e.csvText?t.push(e.csvText.replace("&nbsp;"," ")):e.text&&t.push(e.text.replace("&nbsp;"," ")))}),t},_getColumnNamesFromGrid:function(e){var t=[],r=e.columns;return Ext.Array.each(r,function(e){(e.dataIndex||e.renderer)&&t.push(e.dataIndex)}),t},getCSVFromGrid:function(e,t){return"Ext.data.TreeStore"!=Ext.getClassName(t.getStore())&&"Rally.data.custom.Store"!=Ext.getClassName(t.getStore())?this._getCSVFromWsapiBackedGrid(t):this._getCSVFromCustomBackedGrid(t)},loadStorePage:function(e,t,r,o,n){var a=Ext.create("Deft.Deferred");return t.loadPage(o,{callback:function(r,i,c){var l=[];Rally.getApp().setLoading(Ext.String.format("Page {0} of {1} loaded",o,n));for(var s=0;s<r.length;s++){var d=r[s];l.push(this._getCSVFromRecord(d,e,t))}a.resolve(l)},scope:this}),a},_getCSVFromRecord:function(e,t,r){var o={align:"right",classes:[],cellIndex:9,column:null,columnIndex:9,innerCls:void 0,recordIndex:5,rowIndex:5,style:"",tdAttr:"",tdCls:"x-grid-cell x-grid-td x-grid-cell-headerId-gridcolumn-1029 x-grid-cell-last x-unselectable",unselectableAttr:"unselectable='on'"},n=[],a=t.columns;return Ext.Array.each(a,function(a){if("rallyrowactioncolumn"!=a.xtype)if(a.dataIndex){var i=a.dataIndex,c=e.get(i);!a._csvIgnoreRender&&a.renderer&&(c=a.exportRenderer?a.exportRenderer(c,o,e,0,0,r,t.getView()):a.renderer(c,o,e,0,0,r,t.getView())),n.push(c)}else{c=null;!a._csvIgnoreRender&&a.renderer&&(c=a.exportRenderer?a.exportRenderer(c,o,e,e,0,0,r,t.getView()):a.renderer(c,o,e,e,0,0,r,t.getView()),n.push(c))}},this),'"'+n.join('","')+'"'}});
                !function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof module&&"undefined"!=typeof exports?module.exports=t():e.Papa=t()}(this,function e(){"use strict";var t="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==t?t:{},i=!t.document&&!!t.postMessage,r=i&&/blob:/i.test((t.location||{}).protocol),n={},s=0,a={parse:function(i,r){var o=(r=r||{}).dynamicTyping||!1;if(b(o)&&(r.dynamicTypingFunction=o,o={}),r.dynamicTyping=o,r.transform=!!b(r.transform)&&r.transform,r.worker&&a.WORKERS_SUPPORTED){var h=function(){if(!a.WORKERS_SUPPORTED)return!1;var i,r,o=(i=t.URL||t.webkitURL||null,r=e.toString(),a.BLOB_URL||(a.BLOB_URL=i.createObjectURL(new Blob(["(",r,")();"],{type:"text/javascript"})))),h=new t.Worker(o);return h.onmessage=m,h.id=s++,n[h.id]=h}();return h.userStep=r.step,h.userChunk=r.chunk,h.userComplete=r.complete,h.userError=r.error,r.step=b(r.step),r.chunk=b(r.chunk),r.complete=b(r.complete),r.error=b(r.error),delete r.worker,void h.postMessage({input:i,config:r,workerId:h.id})}var c=null;return a.NODE_STREAM_INPUT,"string"==typeof i?c=r.download?new u(r):new d(r):!0===i.readable&&b(i.read)&&b(i.on)?c=new l(r):(t.File&&i instanceof File||i instanceof Object)&&(c=new f(r)),c.stream(i)},unparse:function(e,t){var i=!1,r=!0,n=",",s="\r\n",o='"',h=o+o,u=!1,f=null,d=!1;!function(){if("object"==typeof t){if("string"!=typeof t.delimiter||a.BAD_DELIMITERS.filter(function(e){return-1!==t.delimiter.indexOf(e)}).length||(n=t.delimiter),("boolean"==typeof t.quotes||"function"==typeof t.quotes||Array.isArray(t.quotes))&&(i=t.quotes),"boolean"!=typeof t.skipEmptyLines&&"string"!=typeof t.skipEmptyLines||(u=t.skipEmptyLines),"string"==typeof t.newline&&(s=t.newline),"string"==typeof t.quoteChar&&(o=t.quoteChar),"boolean"==typeof t.header&&(r=t.header),Array.isArray(t.columns)){if(0===t.columns.length)throw new Error("Option columns is empty");f=t.columns}void 0!==t.escapeChar&&(h=t.escapeChar+o),"boolean"==typeof t.escapeFormulae&&(d=t.escapeFormulae)}}();var l=new RegExp(p(o),"g");if("string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)){if(!e.length||Array.isArray(e[0]))return g(null,e,u);if("object"==typeof e[0])return g(f||c(e[0]),e,u)}else if("object"==typeof e)return"string"==typeof e.data&&(e.data=JSON.parse(e.data)),Array.isArray(e.data)&&(e.fields||(e.fields=e.meta&&e.meta.fields),e.fields||(e.fields=Array.isArray(e.data[0])?e.fields:c(e.data[0])),Array.isArray(e.data[0])||"object"==typeof e.data[0]||(e.data=[e.data])),g(e.fields||[],e.data||[],u);throw new Error("Unable to serialize unrecognized input");function c(e){if("object"!=typeof e)return[];var t=[];for(var i in e)t.push(i);return t}function g(e,t,i){var a="";"string"==typeof e&&(e=JSON.parse(e)),"string"==typeof t&&(t=JSON.parse(t));var o=Array.isArray(e)&&0<e.length,h=!Array.isArray(t[0]);if(o&&r){for(var u=0;u<e.length;u++)0<u&&(a+=n),a+=m(e[u],u);0<t.length&&(a+=s)}for(var f=0;f<t.length;f++){var d=o?e.length:t[f].length,l=!1,c=o?0===Object.keys(t[f]).length:0===t[f].length;if(i&&!o&&(l="greedy"===i?""===t[f].join("").trim():1===t[f].length&&0===t[f][0].length),"greedy"===i&&o){for(var p=[],g=0;g<d;g++){var _=h?e[g]:g;p.push(t[f][_])}l=""===p.join("").trim()}if(!l){for(var v=0;v<d;v++){0<v&&!c&&(a+=n);var y=o&&h?e[v]:v;a+=m(t[f][y],v)}f<t.length-1&&(!i||0<d&&!c)&&(a+=s)}}return a}function m(e,t){if(null==e)return"";if(e.constructor===Date)return JSON.stringify(e).slice(1,25);!0===d&&"string"==typeof e&&null!==e.match(/^[=+\-@].*$/)&&(e="'"+e);var r=e.toString().replace(l,h);return"boolean"==typeof i&&i||"function"==typeof i&&i(e,t)||Array.isArray(i)&&i[t]||function(e,t){for(var i=0;i<t.length;i++)if(-1<e.indexOf(t[i]))return!0;return!1}(r,a.BAD_DELIMITERS)||-1<r.indexOf(n)||" "===r.charAt(0)||" "===r.charAt(r.length-1)?o+r+o:r}}};if(a.RECORD_SEP=String.fromCharCode(30),a.UNIT_SEP=String.fromCharCode(31),a.BYTE_ORDER_MARK="\ufeff",a.BAD_DELIMITERS=["\r","\n",'"',a.BYTE_ORDER_MARK],a.WORKERS_SUPPORTED=!i&&!!t.Worker,a.NODE_STREAM_INPUT=1,a.LocalChunkSize=10485760,a.RemoteChunkSize=5242880,a.DefaultDelimiter=",",a.Parser=g,a.ParserHandle=c,a.NetworkStreamer=u,a.FileStreamer=f,a.StringStreamer=d,a.ReadableStreamStreamer=l,t.jQuery){var o=t.jQuery;o.fn.parse=function(e){var i=e.config||{},r=[];return this.each(function(e){if("INPUT"!==o(this).prop("tagName").toUpperCase()||"file"!==o(this).attr("type").toLowerCase()||!t.FileReader||!this.files||0===this.files.length)return!0;for(var n=0;n<this.files.length;n++)r.push({file:this.files[n],inputElem:this,instanceConfig:o.extend({},i)})}),n(),this;function n(){if(0!==r.length){var t,i,n,h,u=r[0];if(b(e.before)){var f=e.before(u.file,u.inputElem);if("object"==typeof f){if("abort"===f.action)return t="AbortError",i=u.file,n=u.inputElem,h=f.reason,void(b(e.error)&&e.error({name:t},i,n,h));if("skip"===f.action)return void s();"object"==typeof f.config&&(u.instanceConfig=o.extend(u.instanceConfig,f.config))}else if("skip"===f)return void s()}var d=u.instanceConfig.complete;u.instanceConfig.complete=function(e){b(d)&&d(e,u.file,u.inputElem),s()},a.parse(u.file,u.instanceConfig)}else b(e.complete)&&e.complete()}function s(){r.splice(0,1),n()}}}function h(e){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},function(e){var t=y(e);t.chunkSize=parseInt(t.chunkSize),e.step||e.chunk||(t.chunkSize=null),this._handle=new c(t),(this._handle.streamer=this)._config=t}.call(this,e),this.parseChunk=function(e,i){if(this.isFirstChunk&&b(this._config.beforeFirstChunk)){var n=this._config.beforeFirstChunk(e);void 0!==n&&(e=n)}this.isFirstChunk=!1,this._halted=!1;var s=this._partialLine+e;this._partialLine="";var o=this._handle.parse(s,this._baseIndex,!this._finished);if(!this._handle.paused()&&!this._handle.aborted()){var h=o.meta.cursor;this._finished||(this._partialLine=s.substring(h-this._baseIndex),this._baseIndex=h),o&&o.data&&(this._rowCount+=o.data.length);var u=this._finished||this._config.preview&&this._rowCount>=this._config.preview;if(r)t.postMessage({results:o,workerId:a.WORKER_ID,finished:u});else if(b(this._config.chunk)&&!i){if(this._config.chunk(o,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);o=void 0,this._completeResults=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(o.data),this._completeResults.errors=this._completeResults.errors.concat(o.errors),this._completeResults.meta=o.meta),this._completed||!u||!b(this._config.complete)||o&&o.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),u||o&&o.meta.paused||this._nextChunk(),o}this._halted=!0},this._sendError=function(e){b(this._config.error)?this._config.error(e):r&&this._config.error&&t.postMessage({workerId:a.WORKER_ID,error:e,finished:!1})}}function u(e){var t;(e=e||{}).chunkSize||(e.chunkSize=a.RemoteChunkSize),h.call(this,e),this._nextChunk=i?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(e){this._input=e,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(t=new XMLHttpRequest,this._config.withCredentials&&(t.withCredentials=this._config.withCredentials),i||(t.onload=k(this._chunkLoaded,this),t.onerror=k(this._chunkError,this)),t.open(this._config.downloadRequestBody?"POST":"GET",this._input,!i),this._config.downloadRequestHeaders){var e=this._config.downloadRequestHeaders;for(var r in e)t.setRequestHeader(r,e[r])}if(this._config.chunkSize){var n=this._start+this._config.chunkSize-1;t.setRequestHeader("Range","bytes="+this._start+"-"+n)}try{t.send(this._config.downloadRequestBody)}catch(e){this._chunkError(e.message)}i&&0===t.status&&this._chunkError()}},this._chunkLoaded=function(){var e;4===t.readyState&&(t.status<200||400<=t.status?this._chunkError():(this._start+=this._config.chunkSize?this._config.chunkSize:t.responseText.length,this._finished=!this._config.chunkSize||this._start>=(null===(e=t.getResponseHeader("Content-Range"))?-1:parseInt(e.substring(e.lastIndexOf("/")+1))),this.parseChunk(t.responseText)))},this._chunkError=function(e){var i=t.statusText||e;this._sendError(new Error(i))}}function f(e){var t,i;(e=e||{}).chunkSize||(e.chunkSize=a.LocalChunkSize),h.call(this,e);var r="undefined"!=typeof FileReader;this.stream=function(e){this._input=e,i=e.slice||e.webkitSlice||e.mozSlice,r?((t=new FileReader).onload=k(this._chunkLoaded,this),t.onerror=k(this._chunkError,this)):t=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var e=this._input;if(this._config.chunkSize){var n=Math.min(this._start+this._config.chunkSize,this._input.size);e=i.call(e,this._start,n)}var s=t.readAsText(e,this._config.encoding);r||this._chunkLoaded({target:{result:s}})},this._chunkLoaded=function(e){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(e.target.result)},this._chunkError=function(){this._sendError(t.error)}}function d(e){var t;h.call(this,e=e||{}),this.stream=function(e){return t=e,this._nextChunk()},this._nextChunk=function(){if(!this._finished){var e,i=this._config.chunkSize;return i?(e=t.substring(0,i),t=t.substring(i)):(e=t,t=""),this._finished=!t,this.parseChunk(e)}}}function l(e){h.call(this,e=e||{});var t=[],i=!0,r=!1;this.pause=function(){h.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){h.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(e){this._input=e,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){r&&1===t.length&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),t.length?this.parseChunk(t.shift()):i=!0},this._streamData=k(function(e){try{t.push("string"==typeof e?e:e.toString(this._config.encoding)),i&&(i=!1,this._checkIsFinished(),this.parseChunk(t.shift()))}catch(e){this._streamError(e)}},this),this._streamError=k(function(e){this._streamCleanUp(),this._sendError(e)},this),this._streamEnd=k(function(){this._streamCleanUp(),r=!0,this._streamData("")},this),this._streamCleanUp=k(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function c(e){var t,i,r,n=Math.pow(2,53),s=-n,o=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)(e[-+]?\d+)?\s*$/,h=/(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))/,u=this,f=0,d=0,l=!1,c=!1,m=[],_={data:[],errors:[],meta:{}};if(b(e.step)){var v=e.step;e.step=function(t){if(_=t,E())w();else{if(w(),0===_.data.length)return;f+=t.data.length,e.preview&&f>e.preview?i.abort():(_.data=_.data[0],v(_,u))}}}function k(t){return"greedy"===e.skipEmptyLines?""===t.join("").trim():1===t.length&&0===t[0].length}function w(){if(_&&r&&(R("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+a.DefaultDelimiter+"'"),r=!1),e.skipEmptyLines)for(var t=0;t<_.data.length;t++)k(_.data[t])&&_.data.splice(t--,1);return E()&&function(){if(_)if(Array.isArray(_.data[0])){for(var t=0;E()&&t<_.data.length;t++)_.data[t].forEach(i);_.data.splice(0,1)}else _.data.forEach(i);function i(t,i){b(e.transformHeader)&&(t=e.transformHeader(t,i)),m.push(t)}}(),function(){if(!_||!e.header&&!e.dynamicTyping&&!e.transform)return _;function t(t,i){var r,n=e.header?{}:[];for(r=0;r<t.length;r++){var s=r,a=t[r];e.header&&(s=r>=m.length?"__parsed_extra":m[r]),e.transform&&(a=e.transform(a,s)),a=C(s,a),"__parsed_extra"===s?(n[s]=n[s]||[],n[s].push(a)):n[s]=a}return e.header&&(r>m.length?R("FieldMismatch","TooManyFields","Too many fields: expected "+m.length+" fields but parsed "+r,d+i):r<m.length&&R("FieldMismatch","TooFewFields","Too few fields: expected "+m.length+" fields but parsed "+r,d+i)),n}var i=1;return!_.data.length||Array.isArray(_.data[0])?(_.data=_.data.map(t),i=_.data.length):_.data=t(_.data,0),e.header&&_.meta&&(_.meta.fields=m),d+=i,_}()}function E(){return e.header&&0===m.length}function C(t,i){return r=t,e.dynamicTypingFunction&&void 0===e.dynamicTyping[r]&&(e.dynamicTyping[r]=e.dynamicTypingFunction(r)),!0===(e.dynamicTyping[r]||e.dynamicTyping)?"true"===i||"TRUE"===i||"false"!==i&&"FALSE"!==i&&(function(e){if(o.test(e)){var t=parseFloat(e);if(s<t&&t<n)return!0}return!1}(i)?parseFloat(i):h.test(i)?new Date(i):""===i?null:i):i;var r}function R(e,t,i,r){var n={type:e,code:t,message:i};void 0!==r&&(n.row=r),_.errors.push(n)}this.parse=function(n,s,o){var h=e.quoteChar||'"';if(e.newline||(e.newline=function(e,t){e=e.substring(0,1048576);var i=new RegExp(p(t)+"([^]*?)"+p(t),"gm"),r=(e=e.replace(i,"")).split("\r"),n=e.split("\n"),s=1<n.length&&n[0].length<r[0].length;if(1===r.length||s)return"\n";for(var a=0,o=0;o<r.length;o++)"\n"===r[o][0]&&a++;return a>=r.length/2?"\r\n":"\r"}(n,h)),r=!1,e.delimiter)b(e.delimiter)&&(e.delimiter=e.delimiter(n),_.meta.delimiter=e.delimiter);else{var u=function(t,i,r,n,s){var o,h,u,f;s=s||[",","\t","|",";",a.RECORD_SEP,a.UNIT_SEP];for(var d=0;d<s.length;d++){var l=s[d],c=0,p=0,m=0;u=void 0;for(var _=new g({comments:n,delimiter:l,newline:i,preview:10}).parse(t),v=0;v<_.data.length;v++)if(r&&k(_.data[v]))m++;else{var y=_.data[v].length;p+=y,void 0!==u?0<y&&(c+=Math.abs(y-u),u=y):u=y}0<_.data.length&&(p/=_.data.length-m),(void 0===h||c<=h)&&(void 0===f||f<p)&&1.99<p&&(h=c,o=l,f=p)}return{successful:!!(e.delimiter=o),bestDelimiter:o}}(n,e.newline,e.skipEmptyLines,e.comments,e.delimitersToGuess);u.successful?e.delimiter=u.bestDelimiter:(r=!0,e.delimiter=a.DefaultDelimiter),_.meta.delimiter=e.delimiter}var f=y(e);return e.preview&&e.header&&f.preview++,t=n,i=new g(f),_=i.parse(t,s,o),w(),l?{meta:{paused:!0}}:_||{meta:{paused:!1}}},this.paused=function(){return l},this.pause=function(){l=!0,i.abort(),t=b(e.chunk)?"":t.substring(i.getCharIndex())},this.resume=function(){u.streamer._halted?(l=!1,u.streamer.parseChunk(t,!0)):setTimeout(u.resume,3)},this.aborted=function(){return c},this.abort=function(){c=!0,i.abort(),_.meta.aborted=!0,b(e.complete)&&e.complete(_),t=""}}function p(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function g(e){var t,i=(e=e||{}).delimiter,r=e.newline,n=e.comments,s=e.step,o=e.preview,h=e.fastMode,u=t=void 0===e.quoteChar?'"':e.quoteChar;if(void 0!==e.escapeChar&&(u=e.escapeChar),("string"!=typeof i||-1<a.BAD_DELIMITERS.indexOf(i))&&(i=","),n===i)throw new Error("Comment character same as delimiter");!0===n?n="#":("string"!=typeof n||-1<a.BAD_DELIMITERS.indexOf(n))&&(n=!1),"\n"!==r&&"\r"!==r&&"\r\n"!==r&&(r="\n");var f=0,d=!1;this.parse=function(e,a,l){if("string"!=typeof e)throw new Error("Input must be a string");var c=e.length,g=i.length,m=r.length,_=n.length,v=b(s),y=[],k=[],w=[],E=f=0;if(!e)return j();if(h||!1!==h&&-1===e.indexOf(t)){for(var C=e.split(r),R=0;R<C.length;R++){if(w=C[R],f+=w.length,R!==C.length-1)f+=r.length;else if(l)return j();if(!n||w.substring(0,_)!==n){if(v){if(y=[],L(w.split(i)),q(),d)return j()}else L(w.split(i));if(o&&o<=R)return y=y.slice(0,o),j(!0)}}return j()}for(var S=e.indexOf(i,f),x=e.indexOf(r,f),O=new RegExp(p(u)+p(t),"g"),D=e.indexOf(t,f);;)if(e[f]!==t)if(n&&0===w.length&&e.substring(f,f+_)===n){if(-1===x)return j();f=x+m,x=e.indexOf(r,f),S=e.indexOf(i,f)}else{if(-1!==S&&(S<x||-1===x)){if(!(S<D)){w.push(e.substring(f,S)),f=S+g,S=e.indexOf(i,f);continue}var I=U(S,D,x);if(I&&void 0!==I.nextDelim){S=I.nextDelim,D=I.quoteSearch,w.push(e.substring(f,S)),f=S+g,S=e.indexOf(i,f);continue}}if(-1===x)break;if(w.push(e.substring(f,x)),M(x+m),v&&(q(),d))return j();if(o&&y.length>=o)return j(!0)}else for(D=f,f++;;){if(-1===(D=e.indexOf(t,D+1)))return l||k.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:y.length,index:f}),z();if(D===c-1)return z(e.substring(f,D).replace(O,t));if(t!==u||e[D+1]!==u){if(t===u||0===D||e[D-1]!==u){-1!==S&&S<D+1&&(S=e.indexOf(i,D+1)),-1!==x&&x<D+1&&(x=e.indexOf(r,D+1));var T=F(-1===x?S:Math.min(S,x));if(e[D+1+T]===i){w.push(e.substring(f,D).replace(O,t)),e[f=D+1+T+g]!==t&&(D=e.indexOf(t,f)),S=e.indexOf(i,f),x=e.indexOf(r,f);break}var A=F(x);if(e.substring(D+1+A,D+1+A+m)===r){if(w.push(e.substring(f,D).replace(O,t)),M(D+1+A+m),S=e.indexOf(i,f),D=e.indexOf(t,f),v&&(q(),d))return j();if(o&&y.length>=o)return j(!0);break}k.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:y.length,index:f}),D++}}else D++}return z();function L(e){y.push(e),E=f}function F(t){var i=0;if(-1!==t){var r=e.substring(D+1,t);r&&""===r.trim()&&(i=r.length)}return i}function z(t){return l||(void 0===t&&(t=e.substring(f)),w.push(t),f=c,L(w),v&&q()),j()}function M(t){f=t,L(w),w=[],x=e.indexOf(r,f)}function j(e){return{data:y,errors:k,meta:{delimiter:i,linebreak:r,aborted:d,truncated:!!e,cursor:E+(a||0)}}}function q(){s(j()),y=[],k=[]}function U(r,n,s){var a={nextDelim:void 0,quoteSearch:void 0},o=e.indexOf(t,n+1);if(n<r&&r<o&&(o<s||-1===s)){var h=e.indexOf(i,o);if(-1===h)return a;o<h&&(o=e.indexOf(t,o+1)),a=U(h,o,s)}else a={nextDelim:r,quoteSearch:n};return a}},this.abort=function(){d=!0},this.getCharIndex=function(){return f}}function m(e){var t=e.data,i=n[t.workerId],r=!1;if(t.error)i.userError(t.error,t.file);else if(t.results&&t.results.data){var s={abort:function(){r=!0,_(t.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:v,resume:v};if(b(i.userStep)){for(var a=0;a<t.results.data.length&&(i.userStep({data:t.results.data[a],errors:t.results.errors,meta:t.results.meta},s),!r);a++);delete t.results}else b(i.userChunk)&&(i.userChunk(t.results,s,t.file),delete t.results)}t.finished&&!r&&_(t.workerId,t.results)}function _(e,t){var i=n[e];b(i.userComplete)&&i.userComplete(t),i.terminate(),delete n[e]}function v(){throw new Error("Not implemented.")}function y(e){if("object"!=typeof e||null===e)return e;var t=Array.isArray(e)?[]:{};for(var i in e)t[i]=y(e[i]);return t}function k(e,t){return function(){e.apply(t,arguments)}}function b(e){return"function"==typeof e}return r&&(t.onmessage=function(e){var i=e.data;if(void 0===a.WORKER_ID&&i&&(a.WORKER_ID=i.workerId),"string"==typeof i.input)t.postMessage({workerId:a.WORKER_ID,results:a.parse(i.input,i.config),finished:!0});else if(t.File&&i.input instanceof File||i.input instanceof Object){var r=a.parse(i.input,i.config);r&&t.postMessage({workerId:a.WORKER_ID,results:r,finished:!0})}}),(u.prototype=Object.create(h.prototype)).constructor=u,(f.prototype=Object.create(h.prototype)).constructor=f,(d.prototype=Object.create(d.prototype)).constructor=d,(l.prototype=Object.create(h.prototype)).constructor=l,a});
                Ext.define("CustomAgile.ui.FieldPicker",{extend:"Rally.ui.Button",alias:"widget.customagilefieldpicker",config:{stateful:!0,stateId:"CustomAgile.FieldPicker",models:[],selectedFields:[],alwaysSelectedValues:["FormattedID","Name"],fieldBlackList:["GrossEstimateConversionRatio","ObjectID","RevisionHistory","Subscription","Workspace","ObjectUUID","VersionId"],toolTipConfig:{html:"Choose Fields",anchor:"top"}},cls:"field-picker-btn secondary rly-small",iconCls:"icon-add-column",constructor:function(e){this.mergeConfig(e),this.callParent([this.config]),this.on("click",this._onClick),this.fireEvent("ready")},_onClick:function(e){this._createPopover(e.getEl())},_createPopover:function(e){this.popover=Ext.create("Rally.ui.popover.Popover",{target:e,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:"Choose Fields",listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[{xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this.models,context:this.context,alwaysSelectedValues:this.alwaysSelectedValues,fieldBlackList:this.fieldBlackList,alwaysExpanded:!0,width:200,emptyText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",value:this.selectedFields&&this.selectedFields.length?"string"==typeof this.selectedFields[0]?this.selectedFields:_.map(this.selectedFields,e=>e.fieldName):[],listeners:{specialkey:function(e,t){t.getKey()===t.ESC&&this.popover.close()},scope:this}}]})},_onApply:function(e){let t=e.down("rallyfieldpicker").getValue();this.selectedFields=_.map(t,e=>({displayName:e.get("displayName"),fieldName:e.get("name")})),this.saveState(),this.fireEvent("fieldschanged",this.selectedFields),e.close()},getFields:function(){return this.selectedFields},getState:function(){return{selectedFields:this.selectedFields}},applyState:function(e){this.selectedFields=e.selectedFields,this.fireEvent("fieldschanged",this.selectedFields)}});
                Ext.define("Calculator",{config:{bucketBy:"",aggregateBy:""},constructor:function(t){this.initConfig(t)},prepareChartData:function(t){var e=this._groupData(t.getRange()),r=_.keys(e);return"release"===this.bucketBy?this._generateStackedColumns(r,e):this._generateColumns(r,e)},_groupData:function(t){return _.groupBy(t,function(t){var e=t.get("ActualEndDate");return"month"===this.bucketBy?moment(e).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(e).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?t.get("Release")._refObjectName:"year"===this.bucketBy?moment(e).startOf("year").format("YYYY"):void 0},this)},_generateStackedColumns:function(t,e){var r=["Not Started","In Progress","Completed"],a={};return _.each(t,function(t){var n=e[t],u=_.groupBy(n,function(t){return t.get("ActualEndDate")?"Completed":t.get("ActualStartDate")?"In Progress":"Not Started"});_.each(r,function(t){a[t]=a[t]||[];var e=u[t];if("count"===this.aggregateBy)a[t].push(e&&e.length||0);else{var r=_.reduce(e,function(t,e){var r=this.aggregateBy;return t+e.get(r)},0,this);a[t].push(r)}},this)},this),{categories:t,series:_.map(r,function(t){return{name:t,type:"column",data:a[t]}},this)}},_generateColumns:function(t,e){var r;return r="count"===this.aggregateBy?_.map(e,function(t,e){return[e,t.length]}):_.map(e,function(t,e){return[e,_.reduce(t,function(t,e){var r=this.aggregateBy;return t+e.get(r)},0,this)]},this),{categories:t,series:[{name:this.aggregateBy.indexOf("count")>=0?"Throughput":"Velocity",type:"column",data:r}]}}});
                Ext.define("PIVelocityChartApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},autoScroll:!1,requires:["Calculator"],items:[{xtype:"container",itemId:"filter-area",layout:{type:"vbox",align:"stretch"}},{xtype:"container",itemId:"controls-area",layout:"hbox",margin:"10 0 0 0"},{id:"grid-area",xtype:"container",flex:1,type:"vbox",align:"stretch"}],config:{defaultSettings:{bucketBy:"quarter",piType:"PortfolioItem/Feature",aggregateBy:"count",query:""}},launch:function(){Rally.data.wsapi.Proxy.superclass.timeout=18e4,Rally.data.wsapi.batch.Proxy.superclass.timeout=18e4,Ext.override(Rally.ui.combobox.ComboBox,{applyState:function(e){this.store.loading?this.store.on("load",function(){this.setValue(e.value),this.saveState()},this,{single:!0}):(this.setValue(e.value),this.saveState())}}),this.labelWidth=240,this.loading=!0,this.down("#grid-area").on("resize",this.resizeChart,this),this.addLayoutItems(),this.wrap(Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes()).then(e=>this.addSettingItems(e)).then(()=>this.addControls()).then(()=>this.addMultiFilter()).catch(e=>this.showError(e))},resizeChart:function(){var e=this.down("#grid-area"),t=this.down("rallygridboard");e&&t&&t.setHeight(e.getHeight())},addLayoutItems:function(){let e=[{id:Utils.AncestorPiAppFilter.RENDER_AREA_ID,xtype:"container",layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}},{id:Utils.AncestorPiAppFilter.PANEL_RENDER_AREA_ID,xtype:"container",layout:{type:"hbox",align:"middle",defaultMargins:"0 10 10 0"}}];this.getSetting("showSettingsOnFront")?(this.down("#filter-area").add({xtype:"tabpanel",itemId:"filterAndSettingsPanel",stateful:!0,stateId:"pi-velocity-filter-and-settings-panel",header:!1,collapsible:!0,animCollapse:!1,cls:"blue-tabs",activeTab:0,plain:!0,tabBar:{margin:"0 0 0 100"},autoRender:!0,minTabWidth:140,items:[{title:"Filters",html:"",itemId:"filtersTab",padding:5,items:e},{title:"Settings",html:"",itemId:"settingsTab",padding:10}]}),this.addCollapseBtn()):this.down("#filter-area").add(e)},addCollapseBtn:function(){this.collapseBtn=Ext.widget("rallybutton",{text:this.down("#filterAndSettingsPanel").getCollapsed()?"Expand Filters and Settings":"Collapse",floating:!0,shadow:!1,height:21,handler:e=>{this.down("#filterAndSettingsPanel").toggleCollapse(),"Collapse"===e.getText()?(this.ancestorFilterPlugin.hideHelpButton(),e.setText("Expand Filters and Settings")):(e.setText("Collapse"),this.ancestorFilterPlugin.showHelpButton())}}),this.collapseBtn.showBy(this.down("#filterAndSettingsPanel"),"tl-tl",[0,3]),this.shouldCollapseSettings=this.down("#filterAndSettingsPanel").getCollapsed(),this.down("#filterAndSettingsPanel").expand(!1)},addSettingItems:function(e){if(this.portfolioItemTypes=e,this.lowestPiType=this.portfolioItemTypes[0],this.getSetting("showSettingsOnFront")){let e=this.getContext();return new Promise(t=>{this.down("#settingsTab").add([{xtype:"rallycombobox",itemId:"artifactTypeCombo",value:this.getSetting("piType")||this.defaultSettings.piType,stateful:!0,stateId:e.getScopedStateId("pi-velocity-artifact-type-combo"),stateEvents:["change"],fieldLabel:"Type",width:300,labelWidth:120,store:{fields:["Name","TypePath"],data:this.portfolioItemTypes},queryMode:"local",displayField:"Name",valueField:"TypePath",listeners:{scope:this,ready:()=>t(),change:function(e,t,a){this.loading||t!==a&&this.showApplySettingsBtn()}}},{xtype:"rallycombobox",itemId:"aggregateByCombo",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",displayField:"name",valueField:"value",value:this.getSetting("aggregateBy")||this.defaultSettings.aggregateBy,stateful:!0,stateId:e.getScopedStateId("pi-velocity-aggregate-by-combo"),stateEvents:["change"],editable:!1,allowBlank:!1,labelWidth:120,width:300,store:{fields:["name","value"],data:[{name:"Accepted Leaf Story Count",value:"AcceptedLeafStoryCount"},{name:"Accepted Leaf Story Plan Estimate",value:"AcceptedLeafStoryPlanEstimateTotal"},{name:"Count",value:"count"},{name:"Leaf Story Count",value:"LeafStoryCount"},{name:"Leaf Story Plan Estimate",value:"LeafStoryPlanEstimateTotal"},{name:"Preliminary Estimate",value:"PreliminaryEstimateValue"},{name:"Refined Estimate",value:"RefinedEstimate"}]},lastQuery:"",listeners:{scope:this,change:function(e,t,a){this.loading||t!==a&&this.showApplySettingsBtn()}}},{xtype:"rallycombobox",itemId:"bucketByCombo",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",value:this.getSetting("bucketBy")||this.defaultSettings.bucketBy,stateful:!0,stateId:e.getScopedStateId("pi-velocity-bucket-by-combo"),stateEvents:["change"],editable:!1,allowBlank:!1,labelWidth:120,width:300,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:"",listeners:{scope:this,change:function(e,t,a){this.loading||t!==a&&this.showApplySettingsBtn()}}},{xtype:"rallybutton",itemId:"applySettingsBtn",text:"Apply",hidden:!0,handler:function(e){e.hide(),this.update()}.bind(this)}])})}},addControls:function(){let e=this.getContext(),t=this.getType();return new Promise(a=>{this.down("#controls-area").add([{xtype:"container",flex:1},{xtype:"customagilefieldpicker",itemId:"fieldPickerBtn",margin:"0 10 5 0",toolTipConfig:{html:"Columns to Export",anchor:"top"},getTitle:()=>"Export Columns",models:[t],context:e,stateId:e.getScopedStateId(t+"fields"),alwaysSelectedValues:["FormattedID","Name","ActualStartDate","ActualEndDate"],selectedFields:[{displayName:"Formatted ID",fieldName:"FormattedID"},{displayName:"Name",fieldName:"Name"},{displayName:"Actual Start Date",fieldName:"ActualStartDate"},{displayName:"Actual End Date",fieldName:"ActualEndDate"},{displayName:"State",fieldName:"State"},{displayName:"Release",fieldName:"Release"}],listeners:{ready:()=>a(),fieldschanged:this.update,scope:this}},{xtype:"rallybutton",style:{float:"right"},cls:"secondary rly-small",frame:!1,itemId:"actions-menu-button",iconCls:"icon-export",toolTipConfig:{html:"Export",anchor:"top"},listeners:{click:function(e){Ext.widget({xtype:"rallymenu",items:[{text:"Export Summary",handler:()=>this.exportSummary()},{text:"Export Raw Data",handler:()=>this.exportRawData()}]}).showBy(e.getEl()),e.toolTip&&e.toolTip.hide()},scope:this}}])})},addMultiFilter:function(){this.getSetting("showSettingsOnFront")&&this.on("beforeshow",()=>{-1===this.down("#filterAndSettingsPanel").getActiveTab().title.indexOf("FILTERS")&&setTimeout(()=>this.ancestorFilterPlugin.hideHelpButton(),1e3)}),this.down("#"+Utils.AncestorPiAppFilter.RENDER_AREA_ID).add({xtype:"rallybutton",itemId:"applyFiltersBtn",handler:()=>this.update(),text:"Apply filters",cls:"apply-filters-button",disabled:!0}),this.ancestorFilterPlugin=Ext.create("Utils.AncestorPiAppFilter",{ptype:"UtilsAncestorPiAppFilter",pluginId:"ancestorFilterPlugin",settingsConfig:{labelWidth:this.labelWidth},filtersHidden:!1,projectScope:"user",displayMultiLevelFilter:!0,visibleTab:this.down("#artifactTypeCombo")&&this.down("#artifactTypeCombo").getValue()||this.getSetting("piType"),listeners:{scope:this,ready(e){e.addListener({scope:this,select:()=>this.filtersChange(e.getMultiLevelFilters()),change:this.filtersChange}),this.getSetting("showSettingsOnFront")&&(this.updateFilterTabText(e.getMultiLevelFilters()),this.down("#filterAndSettingsPanel").on("beforetabchange",(e,t)=>{t.title.indexOf("FILTERS")>-1?this.ancestorFilterPlugin.showHelpButton():this.ancestorFilterPlugin.hideHelpButton()}),this.shouldCollapseSettings&&(this.down("#filterAndSettingsPanel").collapse(),this.ancestorFilterPlugin.hideHelpButton())),setTimeout(()=>{this.ancestorFilterPlugin._isSubscriber()&&this.down("#applyFiltersBtn")&&this.down("#applyFiltersBtn").hide()},500),this.loading=!1,this.update()}}}),this.addPlugin(this.ancestorFilterPlugin)},filtersChange:function(e){this.updateFilterTabText(e),this.ancestorFilterPlugin._isSubscriber()?this.update():this.down("#applyFiltersBtn").enable()},applyFilters:async function(e){e=e||this.cancelPreviousLoad(),this.setLoading("Loading Filters"),this.down("#applyFiltersBtn").disable(),this.ancestorAndMultiFilters=await this.ancestorFilterPlugin.getAllFiltersForType(this.model.typePath,!0).catch(e=>{this.showError(e)}),this.ancestorAndMultiFilters&&!e.cancelLoad&&this._addChart()},update:async function(){if(this.loading)return;let e=this.cancelPreviousLoad();this.model&&this.getType().toLowerCase()===this.model.typePath.toLowerCase()||await this._loadPIModel().then(e=>this.model=e).catch(e=>this.showError(e)),this.model&&!e.cancelLoad&&this.applyFilters(e)},cancelPreviousLoad(){this.globalStatus&&(this.globalStatus.cancelLoad=!0);let e={cancelLoad:!1};return this.globalStatus=e,e},_loadPIModel:function(){return this.setLoading("Loading Model"),this.wrap(Rally.data.wsapi.ModelFactory.getModel({type:this.getType()}))},_addChart:function(){this.down("#grid-area").removeAll(),this.setLoading("Loading Chart");let e=this.getContext(),t=[this.model.typePath];this.down("#grid-area").add({xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),context:e,modelNames:t,storeConfig:{filters:this._getFilters(),listeners:{scope:this,load:function(){this.setLoading(!1),this.resizeChart()}}}})},_getChartConfig:function(){let e=this.getContext().getDataContext();return this.ancestorFilterPlugin.getIgnoreProjectScope()&&(e.project=null),{xtype:"rallychart",chartColors:this._isByRelease()?["#CCCCCC","#00a9e0","#009933"]:["#009933"],storeType:"Rally.data.wsapi.Store",storeConfig:{context:e,limit:2e4,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:this.model},calculatorType:"Calculator",calculatorConfig:{bucketBy:this.getBucketBy(),aggregateBy:this.getAggregateBy()},chartConfig:{chart:{type:"column",animation:!1},legend:{enabled:this._isByRelease()},title:{text:""},yAxis:{min:0,title:{text:this._getYAxisLabel()},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:"gray"}},reversedStacks:!0},plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!1},showInLegend:!0,colorByPoint:!1},series:{animation:{duration:0}}}}}},_getFilters:function(){var e=[];this._isByRelease()?e.push({property:"Release",operator:"!=",value:null}):e.push({property:"ActualEndDate",operator:"!=",value:null});var t=this.getContext().getTimeboxScope();return t&&t.isApplicable(this.model)&&!this._isByRelease()&&e.push(t.getQueryFilter()),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),this.ancestorAndMultiFilters&&this.ancestorAndMultiFilters.length&&(e=e.concat(this.ancestorAndMultiFilters)),e},getSettingsFields:function(){return[{name:"piType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",labelWidth:this.labelWidth,shouldRespondToScopeChange:!0,storeConfig:{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],autoLoad:!1,remoteFilter:!0,remoteSort:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(e){e.fireEvent("typeselected",e.getValue(),e.context)},ready:function(e){e.fireEvent("typeselected",e.getValue(),e.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(e){this.refreshWithNewContext(e)}}},{name:"aggregateBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",labelWidth:this.labelWidth,displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Accepted Leaf Story Count",value:"AcceptedLeafStoryCount"},{name:"Accepted Leaf Story Plan Estimate",value:"AcceptedLeafStoryPlanEstimateTotal"},{name:"Count",value:"count"},{name:"Leaf Story Count",value:"LeafStoryCount"},{name:"Leaf Story Plan Estimate",value:"LeafStoryPlanEstimateTotal"},{name:"Preliminary Estimate",value:"PreliminaryEstimateValue"},{name:"Refined Estimate",value:"RefinedEstimate"}]},lastQuery:""},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",labelWidth:this.labelWidth,displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:"",handlesEvents:{typeselected:function(e){Rally.data.ModelFactory.getModel({type:e,success:function(e){this.store.filterBy(function(t){return"release"!==t.get("value")||0===e.typeDefinition.Ordinal}),this.store.findRecord("value",this.getValue())||this.setValue("month")},scope:this})}}},{name:"showSettingsOnFront",xtype:"rallycheckboxfield",fieldLabel:"Show Settings On Front",labelWidth:this.labelWidth},{type:"query"}]},updateFilterTabText:function(e){if(this.getSetting("showSettingsOnFront")){var t=0;_.each(e,function(e){t+=e.length});var a=t?`FILTERS (${t})`:"FILTERS",i=this.down("#filterAndSettingsPanel").child("#filtersTab");i&&i.setTitle(a)}},exportSummary:function(){let e,t=this.down("rallygridboard")&&this.down("rallygridboard").getGridOrBoard();if(t&&"object"==typeof t.loadedStores){let a=[[this.getBucketByDisplayName(),...t.chartData.categories]];for(let i of t.chartData.series){console.log(i),e=[`${this.getAggregateByDisplayName()} (${i.name})`];for(let t of i.data)"number"==typeof t?e.push(t):e.push(t.length?t[t.length-1]:0);a.push(e)}try{a=Papa.unparse(a),CArABU.technicalservices.FileUtilities.saveCSVToFile(a,"PI_Throughput_Velocity.csv")}catch(e){this.showError(e)}}else this.showError("No data to export")},exportRawData:function(){let e=this.down("rallygridboard")&&this.down("rallygridboard").getGridOrBoard();if(e&&"object"==typeof e.loadedStores){let t,a=this.getAggregateBy(),i=e.loadedStores.getRange(),l=this.getSelectedFieldDisplayNames(),s=this.getSelectedFields();"count"!==a&&(l.push(this.getAggregateByDisplayName()),s.push(a));let o=[l];for(let e of i){t=[];for(let a of s)t.push(CustomAgile.ui.renderer.RecordFieldRendererFactory.getFieldDisplayValue(e,a,"; ",!0));o.push(t)}try{o=Papa.unparse(o),CArABU.technicalservices.FileUtilities.saveCSVToFile(o,"PI_Throughput_Velocity_raw.csv")}catch(e){this.showError(e)}}else this.showError("No data to export")},getSelectedFields(){return _.map(this.down("#fieldPickerBtn").getFields(),e=>e.fieldName)},getSelectedFieldDisplayNames(){return _.map(this.down("#fieldPickerBtn").getFields(),e=>e.displayName)},onTimeboxScopeChange:function(){this.callParent(arguments),this.update()},getType:function(){return this.down("#artifactTypeCombo")&&this.down("#artifactTypeCombo").getValue()||this.getSetting("piType")},isLowestPiType:function(){return this.lowestPiType&&this.lowestPiType.get("TypePath").toLowerCase()===this.getType().toLowerCase()},getAggregateBy:function(){return this.down("#aggregateByCombo")&&this.down("#aggregateByCombo").getValue()||this.getSetting("aggregateBy")},getAggregateByDisplayName:function(){return this.down("#aggregateByCombo")&&this.down("#aggregateByCombo").getDisplayValue()||this.getSetting("aggregateBy")},getBucketBy:function(){return this.down("#bucketByCombo")&&this.down("#bucketByCombo").getValue()||this.getSetting("bucketBy")},getBucketByDisplayName:function(){return this.down("#bucketByCombo")&&this.down("#bucketByCombo").getDisplayValue()||this.getSetting("bucketBy")},showApplySettingsBtn:function(){this.down("#applySettingsBtn").show()},_getYAxisLabel:function(){var e=this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName;return this.getAggregateBy().indexOf("count")>=0?"Count":e},_getChartFetch:function(){return _.uniq(_.compact(["ActualStartDate","ActualEndDate",...this.isLowestPiType()?["Release"]:[],this.getAggregateBy(),...this.getSelectedFields()]))},_getChartSort:function(){return this._isByRelease()?[{property:"Release.ReleaseDate",direction:"ASC"}]:[{property:"ActualEndDate",direction:"ASC"}]},_isByRelease:function(){return"release"===this.getBucketBy()},showError(e,t){this.setLoading(!1),Rally.ui.notify.Notifier.showError({message:this.parseError(e,t)})},parseError(e,t){if(t=t||"An unknown error has occurred","string"==typeof e&&e.length)return e;if(e.message&&e.message.length)return e.message;if(e.exception&&e.error&&e.error.errors&&e.error.errors.length){if(e.error.errors[0].length)return e.error.errors[0];if(e.error&&e.error.response&&e.error.response.status)return`${t} (Status ${e.error.response.status})`}return e.exceptions&&e.exceptions.length&&e.exceptions[0].error?e.exceptions[0].error.statusText:e.exception&&e.error&&"string"==typeof e.error.statusText&&!e.error.statusText.length&&e.error.status&&524===e.error.status?"The server request has timed out":t},async wrap(e){return e&&_.isFunction(e.then)?new Promise((t,a)=>{e.then({success(...e){t(...e)},failure(e){Rally.getApp().setLoading(!1),a(e)},scope:this})}):Promise.reject(new Error("Wrap cannot process this type of data into a ECMA promise"))},showSettings:function(){this.collapseBtn&&this.collapseBtn.hide(),this.callParent(arguments)},hideSettings:function(){this.collapseBtn&&this.collapseBtn.show(),this.callParent(arguments)},setLoading(e){this.down("#grid-area").setLoading(e)}});

            Rally.launchApp('PIVelocityChartApp', {
                name:"PI Throughput&#x2F;Velocity Chart",
                parentRepos:"",
                version:"1.1.0"
            });

        });
    </script>


    <style type="text/css">
        .blue-tabs .x-tab-bar .x-tab-default{background-color:white;border-radius:4px 4px 0 0}.blue-tabs .x-tab-bar .x-tab-default .x-tab-inner{color:#00a9e0}.blue-tabs .x-tab-bar .x-tab-active{background-color:#00a9e0}.blue-tabs .x-tab-bar .x-tab-active .x-tab-inner{color:white}.blue-tabs .x-tab-bar .x-tab-default .x-tab-inner{text-overflow:initial;-o-text-overflow:initial;overflow:initial}.blue-tabs .x-tab-bar .x-tab-inner{width:100%}.blue-tabs .x-tab-bar .x-tab-default .x-tab-icon-el{color:white}.filter-help{border-color:#d6d6d6 !important}.icon-help{font-size:16px;text-align:center;color:#327c98 !important}.icon-help:hover{color:#21516d !important}.filter-help .x-btn-button{height:18px !important;width:18px !important}.filter-help-list li{padding-bottom:6px}
    </style>
    <style type="text/css">
        .apply-filters-button{background-color:#75c63f}
    </style>
</head>
<body>
</body>
</html>
