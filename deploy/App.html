<!DOCTYPE html>
<html>
<head>
    <title>PI Throughput&#x2F;Velocity Chart</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Calculator",{config:{bucketBy:""},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var groupedData=this._groupData(store.getRange(),"ActualEndDate"),categories=_.keys(groupedData),groupedCycleTimes=_.transform(groupedData,function(result,pis,group){result[group]=this._computeCycleTimes(pis)},{},this),cycleTimeData=_.map(groupedCycleTimes,function(cycleTimes,key){return[key,this._computePercentile(.5,cycleTimes)]},this),percentileData=_.map(groupedCycleTimes,function(cycleTimes){return this._computePercentiles(cycleTimes)},this);return{categories:categories,series:[{name:"Cycle Time",type:"column",data:cycleTimeData},{name:"p25 - p75",type:"errorbar",data:percentileData}]}},_computeCycleTimes:function(pis){return _.sortBy(_.map(pis,function(pi){var startDate=pi.get("ActualStartDate"),endDate=pi.get("ActualEndDate");return moment(endDate).diff(moment(startDate),"days")}))},_computePercentiles:function(cycleTimes){var p25=this._computePercentile(.25,cycleTimes),p75=this._computePercentile(.75,cycleTimes);return p25===p75?[]:[p25,p75]},_computePercentile:function(p,cycleTimes){var index=p*cycleTimes.length,floorIndex=Math.floor(index);return 1===cycleTimes.length?cycleTimes[0]:floorIndex===index?(cycleTimes[floorIndex]+cycleTimes[floorIndex-1])/2:cycleTimes[floorIndex]},_groupData:function(records,field){return _.groupBy(records,function(record){return"month"===this.bucketBy?moment(record.get(field)).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(record.get(field)).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?record.get("Release")._refObjectName:void 0},this)}});
                Ext.define("PIVelocityChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",autoScroll:!1,requires:["Calculator"],config:{defaultSettings:{bucketBy:"quarter",piType:"portfolioitem/feature",query:""}},launch:function(){Rally.data.wsapi.ModelFactory.getModel({type:this.getSetting("piType")}).then({success:function(model){this.model=model,this._addChart()},scope:this})},getSettingsFields:function(){return[{name:"piType",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],allowBlank:!1,editable:!1,autoSelect:!1,validateOnChange:!1,validateOnBlur:!1,fieldLabel:"Type",shouldRespondToScopeChange:!0,storeConfig:{model:"TypeDefinition",sorters:[{property:"Ordinal"}],fetch:["DisplayName","TypePath"],filters:[{property:"Parent.Name",value:"Portfolio Item"},{property:"Creatable",value:!0}],autoLoad:!1,remoteFilter:!0,remoteSort:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{change:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)},ready:function(combo){combo.fireEvent("typeselected",combo.getValue(),combo.context)}},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"}]},lastQuery:"",handlesEvents:{typeselected:function(type){Rally.data.ModelFactory.getModel({type:type,success:function(model){this.store.filterBy(function(record){return"release"!==record.get("value")||0===model.typeDefinition.Ordinal}),this.store.findRecord("value",this.getValue())||this.setValue("month")},scope:this})}}},{type:"query"}]},_addChart:function(){var context=this.getContext(),whiteListFields=["Milestones","Tags"],modelNames=[this.model.typePath],gridBoardConfig={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("filters"),filterChildren:!1,modelNames:modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:[],addQuickFilterConfig:{whiteListFields:whiteListFields}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:whiteListFields}}}}}}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()}};this.add(gridBoardConfig)},_getChartConfig:function(){return{xtype:"rallychart",chartColors:["#005EB8"],storeType:"Rally.data.wsapi.Store",storeConfig:{context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:this.model},calculatorType:"Calculator",calculatorConfig:{bucketBy:this.getSetting("bucketBy")},chartConfig:{chart:{type:"column"},legend:{enabled:!1},title:{text:""},yAxis:{min:0,title:{text:"Days"}},plotOptions:{column:{dataLabels:{enabled:!1}}}}}},onTimeboxScopeChange:function(){this.callParent(arguments);var gridBoard=this.down("rallygridboard");gridBoard&&gridBoard.destroy(),this._addChart()},_getChartFetch:function(){return["ActualStartDate","ActualEndDate","Release"]},_getChartSort:function(){return[{property:"ActualEndDate",direction:"ASC"}]},_getFilters:function(){var queries=[{property:"ActualEndDate",operator:"!=",value:null}];"release"===this.getSetting("bucketBy")&&queries.push({property:"Release",operator:"!=",vaue:null});var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope&&timeboxScope.isApplicable(this.model)&&queries.push(timeboxScope.getQueryFilter()),this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),queries}});

            Rally.launchApp('PIVelocityChartApp', {
                name:"PI Throughput&#x2F;Velocity Chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
